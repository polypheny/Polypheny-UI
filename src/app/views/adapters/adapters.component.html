<div class="mb-3">
    @if (['addStore', 'addSource'].includes( currentRoute() ) ? currentRoute() : '') {
        <!-- availableAdapters -->
        <c-row>
            <c-col>
                <h2>Adapters</h2>
                <br>
            </c-col>
        </c-row>
        <c-row>
            <button cButton color="primary" class="btn-circle topRight" [routerLink]="['./../']">
                <i class="fa fa-close"></i>
            </button>

            @if (availableAdapters()) {
                <c-col>
                    <table cTable size="sm" hover="true" bordered="true" id="adapter-table">
                        <thead>
                        <tr>
                            <th>Logo</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Deploy</th>
                        </tr>
                        </thead>
                        <tbody>
                            @for (adapter of availableAdapters(); track adapter.adapterName) {
                                <tr>
                                    <td class="center">
                                        @if (getLogo( adapter.adapterName ).startsWith( 'assets/' )) {
                                            <img [src]="getLogo(adapter.adapterName)" alt="">
                                        } @else {
                                            <i [class]="getLogo(adapter.adapterName)"></i>
                                        }
                                    </td>
                                    <td><strong>{{ adapter.adapterName }}</strong></td>
                                    <td>{{ adapter.description }}</td>
                                    <td class="center">
                                        <button cButton size="sm" color="primary" (click)="initDeployModal(adapter)">Deploy</button>
                                    </td>
                                </tr>

                            }
                        </tbody>
                    </table>
                </c-col>
            }
        </c-row>
    } @else {
        <!-- show current stores and sources -->
        <div class="mb-3">
            <c-row>
                <c-col size="12">
                    <h2>Stores</h2>
                    <br>
                </c-col>
            </c-row>
            <c-row class="adapters" [gutter]="3">
                <ng-container
                        *ngTemplateOutlet="adapterTemplate; context:{adapters: stores(), type: 'store'}"></ng-container>
            </c-row>
            <br>
        </div>
        <div>
            <c-row>
                <c-col size="12">
                    <h2>Sources</h2>
                    <br>
                </c-col>
            </c-row>
            <c-row class="adapters" [gutter]="3">
                <ng-container
                        *ngTemplateOutlet="adapterTemplate; context:{adapters: sources(), type: 'source'}"></ng-container>
            </c-row>
        </div>
    }

    <!-- template for current stores and sources -->
    <ng-template #adapterTemplate let-adapters="adapters" let-type="type">
        @for (adapter of adapters; track $index) {
            <c-col [lg]="6" class="fixed-width">
                <c-card class="fixed-height">
                    <c-card-header class="card-header-adapter">
                        <p>{{ adapter.name }}</p>
                        @switch (adapter.mode) {
                            @case (DeployMode.DOCKER) {
                                <c-badge color="primary">Docker</c-badge>
                            }
                            @case (DeployMode.REMOTE) {
                                <c-badge color="success">Remote</c-badge>
                            }
                            @case (DeployMode.EMBEDDED) {
                                <c-badge color="info">Embedded</c-badge>
                            }
                        }
                    </c-card-header>
                    <c-card-body>
                        @if (getLogo( adapter.adapterName ).startsWith( 'assets/' )) {
                            <img [src]="getLogo(adapter.adapterName)" alt="" class="logo">
                        } @else {
                            <i [class]="'logo ' + getLogo(adapter.adapterName)"></i>
                        }
                        <span class="mb-2">Adapter: {{ adapter.adapterName }}</span>

                        @if (adapter.dataReadOnly) {
                            <span><span class="fa fa-eye"></span> read-only</span>
                        }
                        @if (adapter.persistent) {
                            <span><span class="fa fa-floppy-o" style="padding-left: 1px"></span> persistent</span>
                        }
                        @if (adapter.settings.hasOwnProperty( 'host' ) && adapter.settings.hasOwnProperty( 'port' )) {
                            <span>{{ adapter.settings['host'] }}
                                @if (adapter.mode === DeployMode.REMOTE) {
                                    <span>: {{ adapter.settings['port'] }}</span>
                                }
                            </span>
                        }
                    </c-card-body>
                    <c-card-footer class="bg-transparent">
                        <button cButton color="danger" (click)="removeAdapter(adapter)"
                                (mouseleave)="resetDeletingAdapter(adapter)" [ngClass]="{'disabled': isDeleting(adapter)}">
                            @if (!isDeleting( adapter )) {
                                <i class="text-white"
                                   [ngClass]="{'cil-trash': adapter !== deletingAdapter, 'cil-warning': adapter === deletingAdapter}"></i>
                            } @else {
                                <c-spinner size="sm" cBorder color="light" role="status"></c-spinner>
                            }
                        </button>
                        <button cButton color="primary" class="pull-right"
                                (click)="initAdapterSettingsConfigureModal(adapter)">
                            Configure
                        </button>
                    </c-card-footer>
                </c-card>

            </c-col>
        }
        <c-col size="1" [lg]="6" class="fixed-height fixed-width add-adapter-wrapper">
            @if (type === 'source') {
                <button cButton color="primary" class="add-btn"
                        [routerLink]="['./addSource']">
                    <i class="fa fa-plus"></i>
                </button>

            } @else if (type === 'store') {
                <button cButton color="primary" class="add-btn" [routerLink]="['./addStore']">
                    <i class="fa fa-plus"></i>
                </button>
            }
        </c-col>
    </ng-template>
</div>


@if (modalActive) {
    <c-modal class="fade" role="dialog" [visible]="modalActive" aria-labelledby="myModalLabel"
             aria-hidden="true" id="editUserModal" (visibleChange)="onVisibilityChange($event)">
        <c-modal-content>
            <c-modal-header>
                <h4 cModalTitle>{{ activeMode() ? "Settings" : "Deployment Mode" }}</h4>
                <button (click)="modalActive = false" cButtonClose></button>
            </c-modal-header>

            <!-- Edit adapter settings -->
            @if (editingAdapterForm) {
                <c-modal-body>
                    <form [formGroup]="editingAdapterForm" autocomplete="off" (ngSubmit)="saveAdapterSettings()" cRow
                          [gutter]="{gy:2}">
                        @for (control of editingAdapterForm.controls | keyvalue; track control.key) {
                            <div class="form-group">
                                @if (getAdapterSetting( control.key )) {
                                    @if (!getAdapterSetting( control.key ).template.options && getAdapterSetting( control.key ).template.type.toLowerCase() !== 'directory') {
                                        <c-input-group class="has-validation">
                                            <ng-container *ngTemplateOutlet="tooltipText;
                                                context: { key: control.key, description: getAdapterSetting(control.key).template.description }"></ng-container>
                                            <input cFormControl type="text" [id]="control.key"
                                                   [formControlName]="control.key"
                                                   [ngClass]="validate(editingAdapterForm, control.key)">
                                            <c-form-feedback>required</c-form-feedback>
                                        </c-input-group>
                                    }
                                    @if (getAdapterSetting( control.key ).template.options) {
                                        <div class="form-group">
                                            <c-input-group class="select-wrapper">
                                                <ng-container *ngTemplateOutlet="tooltipText;
                                    context: { key: control.key, description: getAdapterSetting(control.key).template.description }"></ng-container>
                                                <select cSelect [id]="control.key" [formControlName]="control.key">
                                                    @for (option of getAdapterSetting( control.key ).template.options; track option) {
                                                        <option [value]="option">
                                                            {{ option }}
                                                        </option>
                                                    }
                                                </select>
                                            </c-input-group>
                                        </div>
                                    }
                                    @if (getAdapterSetting( control.key ).template.type.toLowerCase() === 'directory') {
                                        <c-input-group class="has-validation">
                                            <ng-container *ngTemplateOutlet="tooltipText;
                                                context: { key: control.key, description: getAdapterSetting(control.key).template.description }"></ng-container>
                                            @if (!getAdapterSetting( control.key ).template.modifiable) {
                                                <span cFormText disabled></span>
                                            } @else {
                                                <span cFormText
                                                      style="position: relative; text-align: left; white-space: nowrap; overflow: hidden">
                                                    {{ fileLabel }}
                                                </span>
                                            }
                                            <input cFormControl type="file" multiple [id]="control.key"
                                                   [ngClass]="validate(editingAdapterForm, control.key)"
                                                   (change)="onFileChange($event, control.key)"
                                                   [disabled]="!getAdapterSetting(control.key).template.modifiable">
                                            <c-form-feedback>required</c-form-feedback>
                                        </c-input-group>

                                    }

                                }
                            </div>
                        }
                    </form>
                </c-modal-body>

            }
            @if (adapter() && !editingAdapterForm) {

                <!-- Form for deploying -->
                <c-modal-body>
                    @if (!activeMode()) {
                        <div cRow [gutter]="3">
                            @for (mode of adapter().modes.sort(); track $index) {
                                <c-col [xs]="12" class="text-center">
                                    <button cButton size="lg" color="primary" class="btn-block"
                                            (click)="setMode(mode)">{{ mode | titlecase }}
                                    </button>
                                </c-col>
                            }
                        </div>

                    } @else {
                        @if (!handshaking) {
                            <c-container [gutter]="{gy:2}">
                                <form [formGroup]="editingAvailableAdapterForm" (ngSubmit)="deploy()" autocomplete="off" cRow
                                      [gutter]="{gy:2}">
                                    <c-input-group class="has-validation">
                                        <span cInputGroupText>Unique Name</span>
                                        <input cFormControl type="text" id="adapterUniqueName"
                                               formControlName="uniqueName"
                                               [ngClass]="validate(editingAvailableAdapterForm.controls['uniqueName'].value, 'uniqueName')">
                                        <c-form-feedback>{{ getFeedback( editingAvailableAdapterForm ) }}</c-form-feedback>
                                    </c-input-group>

                                    @for (control of editingAvailableAdapterForm.controls | keyvalue: positionOrder(); track control.key) {
                                        @if (control.key !== 'uniqueName' && isSettingDisplayed( control.key )) {
                                            @if (!getAdapterSetting( control.key ).template.options && getAdapterSetting( control.key ).template.type.toLowerCase() !== 'directory') {
                                                <c-input-group class="has-validation">
                                                    <ng-container *ngTemplateOutlet="tooltipText;
                                                    context: { key: control.key, description: getAdapterSetting(control.key).template.description }"></ng-container>
                                                    <input cFormControl type="text" [id]="control.key"
                                                           [formControlName]="control.key"
                                                           [ngClass]="validate(control.value, control.key)">
                                                    <c-form-feedback>{{ getGenericFeedback( control.key ) }}</c-form-feedback>
                                                </c-input-group>
                                            }
                                            @if (getAdapterSetting( control.key ).template.options) {
                                                <c-input-group class="has-validation">
                                                    <ng-container *ngTemplateOutlet="tooltipText;
                                                        context: { key: control.key, description: getAdapterSetting(control.key).template.description }"></ng-container>
                                                    <select cSelect [id]="control.key"
                                                            [ngClass]="validate(control.value, control.key)"
                                                            [formControlName]="control.key"
                                                            (change)="onChange(control.key,control.value)">
                                                        @for (option of getAdapterSetting( control.key ).template.options; track option) {
                                                            <option
                                                                    [value]="option">{{ getAdapterSetting( control.key ).template?.alias?.[option] ? getAdapterSetting( control.key ).template?.alias?.[option] : option }}
                                                            </option>
                                                        }
                                                    </select>
                                                    <c-form-feedback>{{ getGenericFeedback( control.key ) }}</c-form-feedback>
                                                </c-input-group>
                                            }
                                            @if (getAdapterSetting( control.key ).template.type.toLowerCase() === 'directory') {
                                                <c-input-group class="has-validation">
                                                    <ng-container *ngTemplateOutlet="tooltipText;
                                                        context: { key: control.key, description: getAdapterSetting(control.key).template.description }"></ng-container>
                                                    <input cFormControl type="file" (change)="onFileChange($event, control.key)"/>
                                                    <c-form-feedback>{{ getGenericFeedback( control.key ) }}</c-form-feedback>
                                                </c-input-group>
                                            }
                                        }
                                    }
                                </form>
                            </c-container>

                        } @else {
                            <p>Due to the limited permissions available to browsers, Polypheny cannot directly link files via
                                UI.</p>
                            <p>As a security measure, the established link has to be validated by the backend, for this it
                                requires a <i><strong>polypheny.access</strong></i>, with the following content in the target
                                directory:</p>
                            <p><i><strong>{{ this.accessId }}</strong></i></p>
                            <p>This can be done created manually or downloaded:
                                <button cButton color="primary" (click)="createSecureFile()" download>
                                    <i class="cil-file"></i>
                                </button>
                            </p>
                        }
                    }
                </c-modal-body>

            }

            <c-modal-footer>
                <button cButton color="secondary" (click)="modalActive = false">
                    Close
                </button>
                @if (editingAdapterForm) {
                    <button cButton color="primary" type="submit" (click)="saveAdapterSettings()"
                            [disabled]="!editingAdapterForm?.valid || !hasModifiableSettings()">
                        Save
                    </button>
                }
                @if (activeMode() && !handshaking && adapter().task != Task.CHANGE) {
                    <button cButton color="primary"
                            type="submit" (click)="deploy()"
                            [disabled]="!editingAvailableAdapterForm?.valid || deploying || handshaking">
                        @if (!deploying && !handshaking) {
                            <span>Deploy</span>
                        } @else {
                            <c-spinner size="sm" role="status">
                                <span class="sr-only">{{ handshaking ? 'Security checking...' : 'Loading...' }}</span>
                            </c-spinner>
                        }
                    </button>
                }
                @if (handshaking) {
                    <button cButton color="primary" (click)="continueSecureDeploy()">Continue</button>
                }
            </c-modal-footer>
        </c-modal-content><!-- /.modal-content -->
    </c-modal>
}

<ng-template #tooltipText let-key="key" let-description="description">
    @if (description) {
        <span cInputGroupText [cTooltip]="description" cTooltipPlacement="left">
            {{ key }}
        </span>
    } @else {
        <span cInputGroupText>
            {{ key }}
        </span>
    }
</ng-template>
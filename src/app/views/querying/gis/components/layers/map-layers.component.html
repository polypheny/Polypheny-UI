<div class="layers-container">
    <div class="spacer-top"></div>

    <button (click)="toggleAddLayerModalVisibility()" cButton color="primary" class="mx-5">Add layer...</button>

    <div
            *ngIf="this.anyLayersVisible"
            cdkDropList
            [cdkDropListData]="layers"
            (cdkDropListDropped)="dropLayer($event)"
            class="drag-drop-layers"
            cdkDropListSortingDisabled="false"
    >
        <div *ngFor="let layer of layers; trackBy: trackByLayerUuid">
            <c-card *ngIf="!layer.isRemoved"
                    cdkDrag
                    class="layer-card shadow-sm">
                <c-card-header>
                    <span>{{ layer.index }}</span>
                    <div cdkDragHandle class="resize-grip">
                        <span></span><span></span><span></span><span></span><span></span><span></span>
                    </div>
                    <div class="icons">
                        <button *ngIf="layer.isQueryLayer" tooltip="Rerun query" (click)="rerunQuery(layer)"
                                class="rerun-query">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <!--!Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
                                <path d="M105.1 202.6c7.7-21.8 20.2-42.3 37.8-59.8c62.5-62.5 163.8-62.5 226.3 0L386.3 160 352 160c-17.7 0-32 14.3-32 32s14.3 32 32 32l111.5 0c0 0 0 0 0 0l.4 0c17.7 0 32-14.3 32-32l0-112c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 35.2L414.4 97.6c-87.5-87.5-229.3-87.5-316.8 0C73.2 122 55.6 150.7 44.8 181.4c-5.9 16.7 2.9 34.9 19.5 40.8s34.9-2.9 40.8-19.5zM39 289.3c-5 1.5-9.8 4.2-13.7 8.2c-4 4-6.7 8.8-8.1 14c-.3 1.2-.6 2.5-.8 3.8c-.3 1.7-.4 3.4-.4 5.1L16 432c0 17.7 14.3 32 32 32s32-14.3 32-32l0-35.1 17.6 17.5c0 0 0 0 0 0c87.5 87.4 229.3 87.4 316.7 0c24.4-24.4 42.1-53.1 52.9-83.8c5.9-16.7-2.9-34.9-19.5-40.8s-34.9 2.9-40.8 19.5c-7.7 21.8-20.2 42.3-37.8 59.8c-62.5 62.5-163.8 62.5-226.3 0l-.1-.1L125.6 352l34.4 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L48.4 288c-1.6 0-3.2 .1-4.8 .3s-3.1 .5-4.6 1z"/>
                            </svg>
                        </button>
                        <button tooltip="Fit map to layer" (click)="fitLayerToMap(layer)" class="zoom">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <!--!Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
                                <path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"/>
                            </svg>
                        </button>
                        <button tooltip="Toggle layer visibility" (click)="toggleLayerVisibility(layer)" class="eye">
                            <svg *ngIf="layer.isActive" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
                                <!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
                                <path
                                        d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM144 256a144 144 0 1 1 288 0 144 144 0 1 1 -288 0zm144-64c0 35.3-28.7 64-64 64c-7.1 0-13.9-1.2-20.3-3.3c-5.5-1.8-11.9 1.6-11.7 7.4c.3 6.9 1.3 13.8 3.2 20.7c13.7 51.2 66.4 81.6 117.6 67.9s81.6-66.4 67.9-117.6c-11.1-41.5-47.8-69.4-88.6-71.1c-5.8-.2-9.2 6.1-7.4 11.7c2.1 6.4 3.3 13.2 3.3 20.3z"/>
                            </svg>
                            <svg *ngIf="!layer.isActive" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">
                                <!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
                                <path
                                        d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c8.4-19.3 10.6-41.4 4.8-63.3c-11.1-41.5-47.8-69.4-88.6-71.1c-5.8-.2-9.2 6.1-7.4 11.7c2.1 6.4 3.3 13.2 3.3 20.3c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zM373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5L373 389.9z"/>
                            </svg>
                        </button>
                        <button tooltip="Remove layer" (click)="removeLayer(layer)" class="remove">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                                <!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
                                <path
                                        d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
                            </svg>
                        </button>
                    </div>
                </c-card-header>
                <c-card-body class="layer-card-body">
                    <div class="title">
                        <div class="layer-length">
                            Elements: {{ layer.data.length }}
                        </div>
                        <div>
                            <span class="layer-name">{{ layer.name }}</span>
<!--                            TODO: Edit query -->
<!--                            <button cButton class="edit-query-button">-->
<!--                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">-->
<!--                                    &lt;!&ndash;!Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.&ndash;&gt;-->
<!--                                    <path d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/>-->
<!--                                </svg>-->
<!--                                <span>Edit query</span>-->
<!--                            </button>-->
                        </div>
                    </div>
                    <div class="config-sections">
                        <div>
                            <button cButton (click)="runPolyPlan(layer)" >Update plan</button>
                        </div>
                        <app-config-section *ngIf="layer.containsData"
                                            [title]="'Data'"
                                            [config]="layer.dataPreview"></app-config-section>
                        <app-config-section *ngIf="layer.isQueryLayer"
                                            [title]="'Filter'"
                                            [config]="layer.filterConfig"></app-config-section>
                        <app-config-section *ngIf="layer.containsPoints"
                                            [title]="layer.pointShapeVisualization.name"
                                            [config]="layer.pointShapeVisualization"></app-config-section>
                        <app-config-section *ngIf="layer.containsAreas"
                                            [title]="layer.areaShapeVisualization.name"
                                            [config]="layer.areaShapeVisualization"></app-config-section>
                        <app-config-section [title]="layer.colorVisualization.name"
                                            [config]="layer.colorVisualization"></app-config-section>
                        <app-config-section [title]="layer.labelVisualization.name"
                                            [config]="layer.labelVisualization"></app-config-section>
                    </div>
                </c-card-body>
            </c-card>
        </div>

    </div>

    <c-card
            class="layer-card shadow-sm"
    >
        <c-card-header>
            <span>0</span>
        </c-card-header>
        <c-card-body class="layer-card-body">
            <div class="title">
                <span class="layer-name">Base Layer</span>
            </div>
            <div class="config-general">
                <c-input-group>
                    <label cInputGroupText for="baseLayerInputGroup">
                        Tile Map
                    </label>
                    <select [(ngModel)]="selectedBaseLayer" (ngModelChange)="onBaseLayerChange($event)" cSelect
                            id="baseLayerInputGroup">
                        <option
                                *ngFor="let baseLayer of baseLayers"
                                [ngValue]="baseLayer">{{ baseLayer.name }}
                        </option>
                    </select>
                </c-input-group>
            </div>
        </c-card-body>
    </c-card>

    <div class="share-section">
        <span>Download all layers as GeoJSON file:</span>
        <button [disabled]="!anyLayersVisible" (click)="export()" class="share-button" cButton variant="outline">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                <!--!Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
                <path d="M246.6 9.4c-12.5-12.5-32.8-12.5-45.3 0l-128 128c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 109.3 192 320c0 17.7 14.3 32 32 32s32-14.3 32-32l0-210.7 73.4 73.4c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3l-128-128zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64c0 53 43 96 96 96l256 0c53 0 96-43 96-96l0-64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64c0 17.7-14.3 32-32 32L96 448c-17.7 0-32-14.3-32-32l0-64z"/>
            </svg>
            <span>Export</span>
        </button>
    </div>

    <c-modal id="add-layer-modal" [visible]="this.isAddLayerModalVisible"
             (visibleChange)="addLayerModalVisibilityChanged($event)">
        <c-modal-header>
            <h5 cModalTitle>Add layer</h5>
            <button (click)="toggleAddLayerModalVisibility()" cButtonClose></button>
        </c-modal-header>
        <c-modal-body>
            <div class="add-layer-modal-body">
                <div>
                    <label cLabel>Load data</label>
                    <c-input-group>
                        <label cInputGroupText for="layerVisualizationSelect">
                            From
                        </label>
                        <select [(ngModel)]="addLayerMode"
                                cSelect
                                id="layerVisualizationSelect">
                            <option
                                    *ngFor="let mode of addLayerModes"
                                    [ngValue]="mode">{{ mode }}
                            </option>
                        </select>
                    </c-input-group>
                </div>

                <div class="add-layer-query" *ngIf="addLayerMode === LayerContext.Query">
                    <div>
                        <label cLabel>Query</label>
                        <app-query-editor [activeNamespace]="activeNamespace" [language]="language"></app-query-editor>
                    </div>
                    <c-input-group>
                        <label cInputGroupText for="queryLanguage">
                            Query Language
                        </label>
                        <select [(ngModel)]="language"
                                cSelect
                                id="queryLanguage">
                            <option *ngFor="let ql of queryLanguages" value='{{ql.toLowerCase()}}'>{{ ql }}</option>
                        </select>
                    </c-input-group>
                </div>

                <div *ngIf="addLayerMode === LayerContext.External">
                    <label cLabel for="formFile">Upload GeoJSON File</label>
                    <input
                            cFormControl
                            id="formFile"
                            type="file"
                            (change)="loadGeoJsonFile($event)"
                    />
                </div>

                <c-alert *ngIf="addLayerDialogErrorMessage" color="danger">
                    <span><strong>Error</strong></span><br>
                    <span>{{ addLayerDialogErrorMessage }}</span>
                </c-alert>
            </div>

        </c-modal-body>
        <c-modal-footer>
            <button (click)="toggleAddLayerModalVisibility()" cButton color="secondary">
                Cancel
            </button>
            <button (click)="addLayer()" cButton
                    color="primary"> {{ addLayerMode == LayerContext.Query ? 'Execute & Add' : 'Add' }}
            </button>
        </c-modal-footer>
    </c-modal>

    <div style="display: none;">
        <app-alg-viewer #algViewer (polyPlan)="onPolyPlanChanged($event)"></app-alg-viewer>
    </div>

</div>

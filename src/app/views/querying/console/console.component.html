<c-row class="mb-5 gy-3" [hidden]="showingAnalysis" (keydown.alt.shift)="toggleCache(false)"
       (keyup.alt.shift)="revertCache()"
       (keyup.shift.alt)="revertCache()" (keydown.alt.shift.enter)="submitQuery()"
       (keydown.alt.enter)="submitQuery()">
    <c-col class="col-lg-8 col-md-8 col-sm-12">
        <div class="list-group grey-border mb-3" id="console">
            @if (usesAdvancedConsole()) {
                <div id="console-item-head"
                     class="list-group-item header grey-bg px-3 border-bottom">
                    <div class="advanced-console-db-info">
                        <span>Namespace: </span>
                        <select cSelect sizing="sm" class="advanced-console-db-info ms-3"
                                [ngModel]="activeNamespace()"
                                (ngModelChange)="changedDefaultDB($event)">
                            @for (namespace of namespaces(); track namespace.id) {
                                <option
                                        [ngValue]="namespace.name">{{ namespace.name }}
                                </option>
                            }
                        </select>
                        @if (!activeNamespaceExists()) {
                            <span class="ms-3 text-danger"> '{{ activeNamespace() }}' does not exist.</span>
                        }
                    </div>
                </div>
            }
            <div class="form-group"
                 [ngClass]="usesAdvancedConsole() ? 'advanced-console': 'simple-console'">
                <app-editor [language]="language()" #editor id="query-editor"></app-editor>
            </div>
        </div>

        <c-row class="gy-1">
            <c-col>
                <c-form-check>
                    <input cFormCheckInput type="checkbox" id="checkbox1" [(ngModel)]="analyzeQuery">
                    <label cFormCheckLabel for="checkbox1">analyze query</label>
                </c-form-check>
            </c-col>
            <c-col class="ps-sm-0">
                <c-form-check>
                    <input cFormCheckInput type="checkbox" id="checkbox3" [(ngModel)]="useCache">
                    <label cFormCheckLabel for="checkbox3">use cache</label>
                </c-form-check>
            </c-col>
            <c-col class="ps-sm-0">
                <c-form-check>
                    <input cFormCheckInput type="checkbox" id="checkbox2" [(ngModel)]="saveInHistory">
                    <label cFormCheckLabel for="checkbox2">save in history</label>
                </c-form-check>
            </c-col>

            <c-col [offset]="{xs: 0, xxl: 2}" [xs]="6" [lg]="5" [xxl]="4">
                <c-input-group>
                    @if (!loading()) {
                        <select cSelect [ngModel]="language()"
                                (ngModelChange)="setLanguage($event)">
                            <option value="cypher">CYPHER</option>
                            <option value="sql">SQL</option>
                            <option value="mql">MQL</option>
                            <option value="cql">CQL</option>
                            <option value="pig">PIG</option>
                        </select>
                    }
                    @if (!loading()) {
                        <button cButton type="submit" color="primary" (click)="submitQuery()">Execute
                        </button>
                    }
                    @if (loading()) {
                        <button type="submit" cButton color="primary"
                                class="progress-bar-striped progress-bar-animated align-self-end" disabled>Loading
                        </button>
                    }
                </c-input-group>
            </c-col>
        </c-row>
    </c-col>
    <c-col class="col-lg-4 col-md-4 col-sm-12">
        <ul class="list-group" id="history-header">
            <li id="history-item-head" class="list-group-item header px-3">
                <div>
                    <span class="me-1">History</span>
                    <app-delete-confirm (delete)="clearHistory()"></app-delete-confirm>
                </div>
                <div>
                    <button cButton color="primary" size="sm" (click)="openHistorySearch()"
                            [hidden]="showSearch">
                        <i class="fa fa-search"></i>
                    </button>
                    <input #historySearchInput type='text'
                           class='form-control form-control-sm'
                           [(ngModel)]="historySearchQuery"
                           (keydown.esc)="closeHistorySearch()"
                           [hidden]="!showSearch"/>
                    <i class="fa fa-times text-muted search-close"
                       (click)="closeHistorySearch()"
                       [hidden]="!showSearch"></i>
                </div>
            </li>
        </ul>
        <ul class="list-group" id="history">
            @if ((history | searchFilter:historySearchQuery).size == 0) {
                <li class="list-group-item empty"
                >(empty)
                </li>
            }
            @for (h of (history | searchFilter:historySearchQuery) | keyvalue:orderHistory; track h.key) {
                <li class="list-group-item history-item p-1 border-top-0"
                    (click)="applyHistory( h.value.query, h.value.lang, h.value.namespace, false )"
                    (dblclick)="applyHistory( h.value.query, h.value.lang, h.value.namespace, true)">
                    <div class="history-time-wrapper">
                        <small class="time" style="text-transform: uppercase;">{{ h.value.lang }}</small>
                        <small class="time">{{ h.value.displayTime() }}</small>
                        <small class="time">{{ h.value.fromNow() }}</small>
                    </div>
                    <div class="flex-grow-1">
                        <small>{{ _util.limitedString( h.value.query ) }}</small>
                    </div>
                    <app-delete-confirm class="del-hist-item" (delete)="deleteHistoryItem(h.key)"></app-delete-confirm>
                </li>
            }
        </ul>
    </c-col>
</c-row>


<c-row [hidden]="showingAnalysis || loading()">
    @if (dataResultCount() > 1) {
        <c-col class="col-12 mb-3"
               style="display: flex; justify-content: space-between">
            <span class="pt-1 text-muted">Click on a query to view its result and additional information.</span>
            <div id="collapse-btn-wrapper">
                @if (someCollapsed()) {
                    <button cButton color="light" size="sm" (click)="collapseAll(true)" tooltip="expand all"
                            container="body"
                            placement="top" delay="500"><i class="fa fa-expand"></i></button>
                }
                @if (someExpanded()) {
                    <button cButton color="light" size="sm" class="ms-1" (click)="collapseAll(false)" tooltip="collapse all"
                            container="body"
                            placement="top" delay="500"><i class="fa fa-compress"></i></button>
                }
            </div>
        </c-col>
    }
    <c-col class="col-12 mb-3" [ngClass]="{'accordion': results() && dataResultCount() > 1}" id="results">
        @for (item of results(); track i; let i = $index) {
            @switch (item.itemType) {
                @case ('data') {
                    <c-card class="mb-3">
                        <c-card-header
                                [ngClass]="{'pointer': dataResultCount() > 1, 'open': collapsed() !== undefined && collapsed()[i]}"
                                (click)="toggleCollapsed(i)">
                            <div>
                                <strong class="me-3">{{ item.queryIndex }}</strong>
                                <span>{{ item.data.query }}</span>
                            </div>
                            <div>
                                <c-badge class="pull-right" [color]="item.data.error ? 'danger' : 'secondary'">
                                    @if (!item.data.error) {
                                        {{ item.data.affectedTuples }}
                                    }
                                    @if (item.data.error) {
                                        !
                                    }
                                </c-badge>
                            </div>
                        </c-card-header>


                        <c-card-body [visible]="!(collapsed() !== undefined && !collapsed()[i] && dataResultCount() !== 1)"
                                     cCollapse>
                            @if (item.data && item.data.error) {
                                <div class="text-danger">
                                    <strong>Error:</strong>
                                    <p class="mb-3">{{ item.data.error }}</p>
                                </div>
                            }

                            <div class="query-info">
                                @if (item.data && !item.data.data && !item.data.error) {
                                    <p class="mb-3">
                                        <i>Successfully executed</i>
                                    </p>
                                }
                            </div>


                            @if (item.data && item.data.data) {
                                <c-row class="col-lg-12 result-wrapper">
                                    <app-data-view [result]="item.data"
                                                   [config]="entityConfig"
                                                   [loading]="loading()"
                                                   (viewQueryConsumer)="createView($event)"></app-data-view>
                                    @if (item.data.hasMore) {
                                        <p class="text-muted text-center small mt-1 mb-0 w-auto">
                                            Only {{ item.data.data.length }} rows are being displayed. To fetch more rows, please specify
                                            a LIMIT clause.</p>
                                    }
                                </c-row>
                            }
                        </c-card-body>
                    </c-card>
                }
                @case ('info') {
                    <c-card class="mb-3">
                        <c-card-header class="border-bottom-0">
                            <div class="ps-1">
                                <span class="ms-4">{{ item.msg }}</span>
                            </div>
                            <strong [class]="'cil-' + (item.level === 'success' ? 'check-circle' : 'x-circle') + ' text-' + item.level"
                                    class="me-1"></strong>
                        </c-card-header>
                    </c-card>
                }
                @case ('sep') {
                    <div class="d-flex align-items-center mb-2" [ngClass]="{'mt-5': !$first}" style="padding: 0 10%">
                        <div class="flex-grow-1 border-top ms-5" [ngClass]="'border-' + item.level"></div>
                        @if (item.msg) {
                            <small class="px-2" [ngClass]="'text-' + item.level">{{ item.msg }}</small>
                        }
                        <div class="flex-grow-1 border-top me-5" [ngClass]="'border-' + item.level"></div>
                    </div>
                }
            }
        }
    </c-col>
</c-row>

@if (queryAnalysis && showingAnalysis) {
    <app-information-manager
            [data]="queryAnalysis"></app-information-manager>
}


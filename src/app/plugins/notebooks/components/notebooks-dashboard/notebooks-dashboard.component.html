<div class="pb-3">
    <h1>Notebooks</h1>
    <br>
    @if (pluginLoaded) {
        <c-row [gutter]="4">
            <div class="col-xl-4 fixed-width">
                <c-card>
                    <c-card-header>
              <span class="mb-0">Jupyter Server
                  @if (connectedInstance) {
                      ({{ connectedInstance.host.alias }})
                  }
              </span>
                    </c-card-header>
                    <c-card-body>
                        <h5>{{ serverStatus ? 'Online' : 'Offline' }}</h5>
                        @if (serverStatus) {
                            <p>Started: {{ serverStatus.started | date: 'yyyy-MM-dd HH:mm:SS' }}</p>
                            <p>Last Activity: {{ serverStatus.last_activity | date: 'yyyy-MM-dd HH:mm:SS' }}</p>
                        }
                    </c-card-body>
                    <c-card-footer class="bg-transparent">
                        <div class="d-flex gap-1 flex-wrap">
                            @if (serverStatus) {
                                <button cButton color="danger" class="pull-right"
                                        (click)="destroyContainerModal.visible = true">
                                    <svg [cIcon]="icons.cilTrash" title="List Icon"></svg>
                                    Destroy
                                </button>
                            }
                            @if (serverStatus) {
                                <button cButton color="danger" class="pull-right me-2"
                                        (click)="restartContainerModal.visible = true">
                                    <svg [cIcon]="icons.cilReload" title="List Icon"></svg>
                                    Restart
                                </button>
                            }
                            @if (!serverStatus) {
                                <button cButton color="success" class="pull-right me-2"
                                        (click)="startContainerModal.visible = true">
                                    <svg [cIcon]="icons.cilMediaPlay" title="List Icon"></svg>
                                    Start
                                </button>
                            }
                        </div>
                    </c-card-footer>
                </c-card>
            </div>
            @if (serverStatus) {
                <div class="col-lg-auto fixed-width">
                    <c-card>
                        <c-card-header>
                            <span class="mb-0">Kernels</span>
                        </c-card-header>
                        <c-card-body>
                            @if (sessions.length === 0) {
                                <h5>No Kernel Running</h5>
                            } @else {
                                <h5>Running Kernels ({{ sessions.length }})</h5>
                                <table class="table table-hover table-striped">
                                    <thead>
                                    <tr>
                                        <th>Notebook</th>
                                        <th>Kernel</th>
                                        <th>Last Activity</th>
                                        <th>Status</th>
                                        <th>Connections</th>
                                        <th></th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                        @for (session of sessions; track session.id; let i = $index) {
                                            <tr>
                                                <td>{{ notebookPaths[i] }}</td>
                                                <td>{{ session.kernel.name }}</td>
                                                <td>{{ session.kernel.last_activity | date: 'yyyy-MM-dd HH:mm:SS' }}</td>
                                                <td>{{ session.kernel.execution_state }}</td>
                                                <td>{{ session.kernel.connections }}</td>
                                                <th></th>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                        </c-card-body>
                        <c-card-footer class="bg-transparent">
                            <div class="pull-right">
                                @if (hasUnusedSessions) {
                                    <button cButton color="danger" variant="outline" class="me-2"
                                            (click)="terminateUnusedSessionsModal.visible = true">
                                        Shut Down Unused
                                    </button>
                                }
                                <button cButton color="danger" [disabled]="sessions.length === 0"
                                        (click)="terminateSessionsModal.visible = true">
                                    Shut Down All
                                </button>
                            </div>
                        </c-card-footer>
                    </c-card>
                </div>
            }
        </c-row>
    } @else {
        <p>The Jupyter Plugin is not loaded. Refresh the page to try again.</p>
    }
</div>


<c-modal #terminateSessionsModal class="modal" tabindex="-1" role="dialog"
         aria-labelledby="terminateSessionsModal" aria-hidden="true">
    <c-modal-content>
        <c-modal-header>
            <h4 cModalTitle>Shut Down All Kernels</h4>
            <button cButtonClose type="button" (click)="terminateSessionsModal.visible = false" aria-label="Close"></button>
        </c-modal-header>

        <c-modal-body>
            <p>Are you sure you want to shut down all running kernels? Unsaved changes might be lost.</p>
        </c-modal-body>
        <c-modal-footer>
            <button cButton color="secondary" type="button" (click)="terminateSessionsModal.visible = false">Cancel</button>
            <button cButton color="danger" type="button" (click)="terminateSessions(false)"
                    [disabled]="deleting">
                @if (!deleting) {
                    <span>Shut Down All</span>
                }
                @if (deleting) {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                }
            </button>
        </c-modal-footer>
    </c-modal-content>
</c-modal>

<c-modal #terminateUnusedSessionsModal tabindex="-1" role="dialog"
         aria-labelledby="terminateSessionsModal" aria-hidden="true">
    <c-modal-content>
        <c-modal-header>
            <h4 cModalTitle>Shut Down Unused Kernels</h4>
            <button cButtonClose type="button" class="close" (click)="terminateUnusedSessionsModal.visible = false"
                    aria-label="Close"></button>
        </c-modal-header>

        <c-modal-body>
            <p>Are you sure you want to shut down all kernels with no open connections?</p>
        </c-modal-body>
        <c-modal-footer>
            <button cButton color="secondary" type="button" (click)="terminateUnusedSessionsModal.visible = false">Cancel
            </button>
            <button cButton color="danger" type="button" (click)="terminateSessions(true)"
                    [disabled]="deleting">
                @if (!deleting) {
                    <span>Shut Down Unused</span>
                }
                @if (deleting) {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                }
            </button>
        </c-modal-footer>
    </c-modal-content>
</c-modal>

<c-modal #restartContainerModal tabindex="-1" role="dialog"
         aria-labelledby="terminateSessionsModal" aria-hidden="true">
    <c-modal-content>
        <c-modal-header>
            <h4 cModalTitle>Restart Jupyter Server Container</h4>
            <button cButtonClose type="button" class="close" (click)="restartContainerModal.visible = false" aria-label="Close">
            </button>
        </c-modal-header>

        <c-modal-body>
            <p>Are you sure you want to restart the Jupyter Server container? This will shut down all running
                kernels. Unsaved changes might be lost.</p>
        </c-modal-body>
        <c-modal-footer>
            <button cButton color="secondary" type="button" (click)="restartContainerModal.visible = false">Cancel</button>
            <button cButton color="danger" type="button" (click)="restartContainer()">
                <span>Restart</span>
            </button>
        </c-modal-footer>
    </c-modal-content>
</c-modal>

<c-modal #destroyContainerModal tabindex="-1" role="dialog"
         aria-labelledby="terminateSessionsModal" aria-hidden="true">
    <c-modal-content>
        <c-modal-header class="modal-header">
            <h4 cModalTitle>Destroy Jupyter Server Container</h4>
            <button cButtonClose type="button" (click)="destroyContainerModal.visible = false" aria-label="Close"></button>
        </c-modal-header>

        <c-modal-body>
            <p>Are you sure you want to destroy the Jupyter Server Docker container? This will shut down all running
                kernels. Unsaved changes might be lost.</p>
        </c-modal-body>
        <c-modal-footer>
            <button cButton color="secondary" type="button" (click)="destroyContainerModal.visible = false">Cancel</button>
            <button cButton color="danger" type="button" (click)="destroyContainer()">
                <span>Destroy</span>
            </button>
        </c-modal-footer>
    </c-modal-content>
</c-modal>

<c-modal #startContainerModal tabindex="-1" role="dialog"
         aria-labelledby="terminateSessionsModal" aria-hidden="true">
    <c-modal-header>
        <h4 cModalTitle>Deploy Jupyter Server Container</h4>
        <button cButtonClose type="button" (click)="startContainerModal.visible = false" aria-label="Close"></button>
    </c-modal-header>

    <c-modal-body>
        Select the Docker instance to use:
        <select cSelect name="instanceId" #selectedInstance class="form-control"
                [disabled]="instances.length === 0">
            @if (instances.length === 0) {
                <option>No instances available</option>
            }
            @for (instance of instances; track instance.id) {
                <option [value]="instance.id">{{ instance.host.alias }}</option>
            }
        </select>
        @if (instances.length === 0) {
            <div class="alert alert-info mt-3">
                To add a Docker instance go to Config &gt; Docker.
            </div>
        }
        @if (instances.length > 0) {
            <div class="alert alert-warning mt-3">
                The Jupyter image is very large, it might take some time to download.
            </div>
        }
    </c-modal-body>
    <c-modal-footer>
        <button cButton color="secondary" type="button" (click)="startContainerModal.visible = false">Cancel</button>
        <button cButton color="success" type="button" (click)="createContainer(+(selectedInstance.value))"
                [disabled]="creating || instances.length === 0">
            @if (creating) {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"
                ></span>
            }
            <span>Start</span>
        </button>
    </c-modal-footer>
</c-modal>

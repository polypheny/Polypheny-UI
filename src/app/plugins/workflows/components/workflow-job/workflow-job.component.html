<app-job-creator></app-job-creator>
<app-execution-monitor #executionMonitor [sessionId]="sessionId()" [workflow]="workflow()" [canOpen]="false"/>

@if (job()) {
    <div class="d-flex justify-content-between mb-3">
        <h1 class="job-name">
            {{ job().name }}
        </h1>
        <div>
            <button cButton color="secondary" (click)="backToDashboard()">Back</button>
        </div>
    </div>
    <c-button-group size="lg" id="enable-radios" class="mb-5">
        <button cButton [color]="!isEnabled() ? 'dark' : 'danger'" [variant]="!isEnabled() ? null : 'outline'"
                (click)="disableJob()">
            Disabled
        </button>
        <button cButton [color]="isEnabled() ? 'dark' : 'success'" [variant]="isEnabled() ? null : 'outline'"
                (click)="enableJob()">
            Enabled
        </button>
    </c-button-group>
    <c-row class="mb-5">
        <c-col [md]="6" class="fixed-width">
            <c-card>
                <c-card-header>
                    <h5 class="mb-0">Job Information</h5>
                </c-card-header>
                <c-card-body>
                    <c-row>
                        <c-col [xs]="6"><small><strong>Type:</strong></small></c-col>
                        <c-col [xs]="6">
                            <small>{{ job().type }}</small>
                        </c-col>
                    </c-row>
                    <c-row>
                        <c-col [xs]="6"><small><strong>Workflow:</strong></small></c-col>
                        <c-col [xs]="6"><small>
                            {{ _creator.workflowDefs()[job().workflowId]?.name }}
                            v{{ job().version }}
                        </small></c-col>
                    </c-row>
                    <c-row>
                        <c-col [xs]="6"><small><strong>Enabled on Startup:</strong></small></c-col>
                        <c-col [xs]="6"><small> {{ job().enableOnStartup }} </small></c-col>
                    </c-row>
                    <c-row>
                        <c-col [xs]="6"><small><strong>Retries:</strong></small></c-col>
                        <c-col [xs]="6"><small> {{ job().maxRetries }} </small></c-col>
                    </c-row>
                    <c-row>
                        <c-col [xs]="6"><small><strong>Optimizations:</strong></small></c-col>
                        <c-col [xs]="6"><small> {{ job().performance }} </small></c-col>
                    </c-row>
                    <c-row>
                        <c-col [xs]="6"><small><strong>Overwrites Variables:</strong></small></c-col>
                        <c-col [xs]="6"><small> {{ Object.keys( job().variables || {} ).length > 0 }} </small></c-col>
                    </c-row>
                    @if (job().type === 'SCHEDULED') {
                        <c-row>
                            <c-col [xs]="6"><small><strong>Schedule:</strong></small></c-col>
                            <c-col [xs]="6"><small>{{ job().schedule }}</small></c-col>
                        </c-row>
                    }
                    <div class="mt-3">
                        <button cButton color="secondary" (click)="editJob()" [disabled]="isEnabled()">
                            Modify
                        </button>
                        <button cButton color="danger" [disabled]="isEnabled()" class="ms-1"
                                (mouseleave)="deleteConfirm.set(false)"
                                (click)="onDeleteClick()">
                            @if (deleteConfirm()) {
                                <span>Delete Job </span>
                                <span class="fa fa-warning"></span>
                            } @else {
                                <span>Delete Job</span>
                            }
                        </button>

                    </div>
                </c-card-body>
            </c-card>
        </c-col>

        <c-col [md]="6" class="fixed-width">
            <c-card>
                <c-card-header>
                    <h5 class="mb-0">Workflow Session</h5>
                </c-card-header>
                <c-card-body>
                    @if (session()) {
                        <c-row>
                            <c-col [xs]="6"><small><strong>State:</strong></small></c-col>
                            <c-col [xs]="6"><small>{{ session().state }}</small></c-col>
                        </c-row>
                        <c-row>
                            <c-col [xs]="6"><small><strong>Last Interaction:</strong></small></c-col>
                            <c-col [xs]="6">
                                <small>{{ session().lastInteraction | date: 'yyyy-MM-dd HH:mm:ss' }}</small>
                            </c-col>
                        </c-row>
                        <c-row>
                            <c-col [xs]="6"><small><strong>Connected Users:</strong></small></c-col>
                            <c-col [xs]="6"><small>{{ session().connectionCount }}</small></c-col>
                        </c-row>
                        <button cButton color="primary" class="mt-3" (click)="openSession()">Open</button>
                    } @else {
                        Enable the job to start the corresponding session.
                    }
                </c-card-body>
            </c-card>
        </c-col>
    </c-row>

    @if (session()) {
        <h2>Execution History ({{ session().executionHistory?.length || 0 }})</h2>
        <button cButton color="primary" (click)="executeJob()" class="mb-4" [disabled]="session().state !== 'IDLE'">
            Manually Trigger Execution
        </button>
        <ul cListGroup *ngIf="session().executionHistory" class="mb-5">
            @for (exec of session().executionHistory; track $index) {
                <li cListGroupItem>
                    <c-row class="mb-3">
                        <c-col [xs]="1">
                            <h5>
                                @switch (exec.result) {
                                    @case (JobResult.SUCCESS) {
                                        <span class="badge bg-success">Success</span>
                                    }
                                    @case (JobResult.FAILED) {
                                        <span class="badge bg-danger">Failed</span>
                                    }
                                    @case (JobResult.SKIPPED) {
                                        <span class="badge bg-warning">Skipped</span>
                                    }
                                }
                            </h5>
                        </c-col>
                        <c-col [xs]="3">
                            <h5>
                                <span>
                                    {{ exec.startTime | date: 'yyyy-MM-dd HH:mm:ss' }}
                                </span>
                            </h5>
                        </c-col>
                        <c-col [xs]="6">
                            <h5>{{ exec.message }}</h5>
                        </c-col>
                    </c-row>

                    <div class="mb-1">
                        @if (exec.statistics) {
                            <p *ngIf="exec.statistics"><strong>Duration: </strong> {{ exec.statistics.totalDuration }} ms</p>
                            <button cButton color="secondary" *ngIf="workflow()" size="sm"
                                    (click)="executionMonitor.show(exec.statistics)">Statistics
                            </button>
                        }
                        @if (exec.variables) {
                            <button cButton color="secondary" *ngIf="workflow()" size="sm" [class.ms-1]="exec.statistics"
                                    (click)="openVariables(exec.variables)">Variables
                            </button>
                        }
                    </div>
                </li>
            } @empty {
                <li cListGroupItem>
                    Workflow was not yet executed.
                </li>
            }
        </ul>
    }
}

<c-modal [visible]="showVariablesModal()" (visibleChange)="showVariablesModal.set($event)">
    <c-modal-header>
        <h5 cModalTitle>Workflow Variables</h5>
        <button (click)="showVariablesModal.set(false)" cButtonClose></button>
    </c-modal-header>
    <c-modal-body *ngIf="showVariablesModal()">
        <app-json-text [text]="selectedVariablesStr"></app-json-text>
    </c-modal-body>
    <c-modal-footer>
        <button (click)="showVariablesModal.set(false)" cButton color="secondary">Close</button>
    </c-modal-footer>
</c-modal>

<c-modal [visible]="showDisableModal()" (visibleChange)="showDisableModal.set($event)">
    <c-modal-header>
        <h5 cModalTitle>Disable Job</h5>
        <button (click)="showDisableModal()" cButtonClose></button>
    </c-modal-header>
    <c-modal-body>
        Do you really want to disable this Job? The action will reset the execution history.
    </c-modal-body>
    <c-modal-footer>
        <button (click)="showDisableModal.set(false)" cButton color="secondary">Close</button>
        <div>
            <button cButton color="danger" (click)="disableJob()">Disable Job</button>
        </div>
    </c-modal-footer>
</c-modal>
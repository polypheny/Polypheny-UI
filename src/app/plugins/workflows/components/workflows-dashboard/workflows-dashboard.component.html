<h1>Workflow Dashboard</h1>

<c-input-group class="mb-3">
    <input cFormControl placeholder="Workflow Name" [(ngModel)]="newWorkflowName"/>
    <button cButton color="primary" type="button" (click)="createAndOpenWorkflow()">
        Create Workflow
    </button>
</c-input-group>

<h2>Stored Workflows</h2>

<c-accordion class="mb-5">
    <ng-container *ngFor="let entry of sortedWorkflowDefs">
        <c-accordion-item #item="cAccordionItem" [visible]="false">
            <ng-template cTemplateId="accordionHeaderTemplate">
                <button (click)="item.toggleItem()" [collapsed]="!item.visible" cAccordionButton>
                    <div class="d-flex justify-content-between flex-grow-1">
                        <h4 class="flex-grow-1">{{ entry.value.name }}</h4>

                        <c-input-group class="me-5 w-auto">
                            <select id="versionSelect-{{entry.key}}" class="form-control px-4" [(ngModel)]="selectedVersion[entry.key]" (click)="$event.stopPropagation()">
                                <option *ngFor="let version of entry.value.versions | keyvalue" [value]="version.key">v{{ version.key }}</option>
                            </select>
                            <button cButton color="primary" type="button" (click)="$event.stopPropagation(); openVersion(entry.key);">
                                Open
                            </button>
                        </c-input-group>
                    </div>
                </button>
            </ng-template>
            <ng-template cTemplateId="accordionBodyTemplate">
                <div class="accordion-body">
                    <!--<div class="form-group">
                        <label for="versionSelect-{{entry.key}}"><strong>Version</strong></label>
                        <select id="versionSelect-{{entry.key}}" class="form-control" [(ngModel)]="selectedVersion[entry.key]">
                            <option *ngFor="let version of entry.value.versions | keyvalue" [value]="version.key">{{ version.key }}</option>
                        </select>
                    </div>-->

                    <div class="">
                        <div>
                            <strong>Version Description:</strong> {{ entry.value.versions[selectedVersion[entry.key]].description }}
                        </div>
                        <div>
                            <strong>Creation Time:</strong> {{ entry.value.versions[selectedVersion[entry.key]].creationTime | date:'short' }}
                        </div>
                        <button cButton color="danger" type="button" class="mt-3" (click)="$event.stopPropagation();">
                            Delete
                        </button>

                        <!--<button class="btn btn-primary mt-3" (click)="openVersion(entry.key)">
                            Open Version
                        </button>-->
                    </div>

                </div>
            </ng-template>
        </c-accordion-item>
    </ng-container>
</c-accordion>

<h2>Active Sessions</h2>
<ul cListGroup *ngIf="workflowDefs" class="mb-5">
    <ng-container *ngFor="let session of sessions | keyvalue">
        <li cListGroupItem>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong *ngIf="session.value.type === 'USER_SESSION'">
                        {{workflowDefs[session.value.workflowId].name}}
                        v{{session.value.version}}
                    </strong>
                    <strong *ngIf="session.value.type !== 'USER_SESSION'">
                        {{session.value.type}}
                    </strong>

                    <div>
                        <small><strong>SessionId:</strong> {{ session.value.sessionId }}</small><br/>
                        <small><strong>Connected Users:</strong> {{ session.value.connectionCount }}</small><br/>
                    </div>
                </div>
                <button class="btn btn-primary btn-sm" (click)="openSession(session.value.sessionId)">
                    Open
                </button>
            </div>
        </li>
    </ng-container>
</ul>

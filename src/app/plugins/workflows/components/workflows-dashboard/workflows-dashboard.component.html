@switch (route()) {
    @case ('dashboard') {
        <h1 class="mb-4">Workflows</h1>

        <c-row class="mb-5">
            <c-col [md]="6" class="fixed-width">
                <c-card>
                    <c-card-header>
                        <span class="mb-0">Create Workflow</span>
                    </c-card-header>
                    <c-card-body>
                        <c-input-group class="mb-3" cCol>
                            <span cInputGroupText>Name</span>
                            <input cFormControl placeholder="Workflow Name" [(ngModel)]="newWorkflowName"
                                   autocomplete="off"/>
                        </c-input-group>
                        <c-input-group class="mb-3">
                            <span cInputGroupText>Folder</span>
                            <input cFormControl placeholder="Default Folder" [(ngModel)]="newWorkflowGroup"
                                   autocomplete="off"/>
                        </c-input-group>
                        <c-input-group class="mb-0 justify-content-end">
                            <button cButton color="primary" (click)="createAndOpenWorkflow()"
                                    [disabled]="!newWorkflowName">Create
                            </button>
                        </c-input-group>
                    </c-card-body>
                </c-card>
            </c-col>
            <c-col [md]="6" class="fixed-width">
                <c-card>
                    <c-card-header>
                        <span class="mb-0">Upload Workflow</span>
                    </c-card-header>
                    <c-card-body>
                        <c-input-group class="mb-3" cCol>
                            <span cInputGroupText>Name</span>
                            <input cFormControl placeholder="Workflow Name" [(ngModel)]="uploadWorkflowName"
                                   autocomplete="off"/>
                        </c-input-group>
                        <c-input-group class="mb-3">
                            <span cInputGroupText>Folder</span>
                            <input cFormControl placeholder="Default Folder" [(ngModel)]="uploadWorkflowGroup"
                                   autocomplete="off"/>
                        </c-input-group>
                        <c-input-group class="mb-3">
                            <input cFormControl id="uploadWorkflow" type="file" accept=".json,.txt"
                                   (change)="onFileChange($event.target['files'])"/>
                        </c-input-group>

                        <c-input-group class="mb-0 justify-content-end">
                            <button cButton color="primary" (click)="importWorkflow()"
                                    [disabled]="!uploadWorkflowName || !uploadedWorkflow">Upload
                            </button>
                        </c-input-group>
                    </c-card-body>
                </c-card>
            </c-col>
        </c-row>

        <h2 class="mb-3">Stored Workflows ({{ workflowDefsCount }})</h2>

        @for (group of sortedGroups; track group.groupName) {
            @if (group.groupName.length > 0) {
                <div class="mb-1"
                     (click)="toggleCollapse(group.groupName)" style="cursor: pointer;">
                    <h4>
                        <i class="fa me-3"
                           [ngClass]="{'fa-folder-o': !visibleGroups[group.groupName](), 'fa-folder-open-o': visibleGroups[group.groupName]()}"></i>
                        {{ group.groupName }} ({{ group.defs.length }})
                    </h4>
                </div>
            }

            <div cCollapse [visible]="visibleGroups[group.groupName]()" class="mb-3">
                <c-accordion>
                    @for (def of group.defs; track def.id) {
                        <c-accordion-item #item="cAccordionItem" [visible]="false">
                            <ng-template cTemplateId="accordionHeaderTemplate">
                                <button (click)="item.toggleItem()" [collapsed]="!item.visible" cAccordionButton>
                                    <div class="d-flex flex-column w-100">
                                        <div class="d-flex justify-content-between flex-grow-1">
                                            <div class="flex-grow-1 limit-name-width">
                                                <h5 class="workflow-name">{{ def.def.name }}</h5>
                                                <span class="text-muted">{{ def.def.versions[selectedVersion[def.id]].description }}</span>
                                            </div>

                                            <div>
                                                <c-input-group class="me-5 w-auto">
                                                    <select id="versionSelect-{{def.id}}" class="form-control px-4"
                                                            [(ngModel)]="selectedVersion[def.id]"
                                                            (click)="$event.stopPropagation()">
                                                        @for (version of def.def.versions | keyvalue; track version.key) {
                                                            <option [value]="version.key">v{{ version.key }}</option>
                                                        }
                                                    </select>
                                                    <button cButton color="primary" type="button"
                                                            (click)="$event.stopPropagation(); openVersion(def.id);">
                                                        Open
                                                    </button>
                                                </c-input-group>
                                            </div>
                                        </div>

                                        @if (def.def.description) {
                                            <div class="mt-2 me-5">
                                                <div class="d-flex align-items-center" (click)="toggleExpandDescription(def.id); $event.stopPropagation()" style="cursor: pointer; user-select: none;">
                                                    <strong>
                                                        <span [class]="expandedDescriptions.has(def.id) ? 'fa fa-angle-down me-1' : 'fa fa-angle-right me-2'" class=""></span>
                                                        {{ expandedDescriptions.has( def.id ) ? 'Hide Description' : 'Show Description' }}
                                                    </strong>
                                                </div>
                                                <div [visible]="expandedDescriptions.has(def.id)" cCollapse>
                                                    <div class="ms-0 text-muted expanded-description">{{ def.def.description }}</div>
                                                </div>
                                            </div>
                                        }

                                    </div>
                                </button>
                            </ng-template>
                            <ng-template cTemplateId="accordionBodyTemplate">
                                <div class="accordion-body">
                                    <c-row class="mb-3">
                                        <c-col [md]="4">
                                            <c-input-group>
                                                <input cFormControl type="text" #nameInput placeholder="Enter new name">
                                                <button cButton color="light"
                                                        (click)="changeName(def.id, nameInput.value); nameInput.value = ''"
                                                        [disabled]="!nameInput.value || nameInput.value === def.def.name">
                                                    Change Name
                                                </button>
                                            </c-input-group>

                                        </c-col>
                                        <c-col [md]="4">
                                            <c-input-group>
                                                <input cFormControl type="text" #groupInput
                                                       placeholder="Enter new group">
                                                <button cButton color="light"
                                                        (click)="changeGroup(def.id, groupInput.value); groupInput.value = ''"
                                                        [disabled]="groupInput.value === def.def.group">
                                                    Change Group
                                                </button>
                                            </c-input-group>
                                        </c-col>
                                        <c-col [md]="2">
                                            <button cButton color="light" (click)="openDescriptionModal(def.id)">
                                                Set Description
                                            </button>
                                        </c-col>
                                        <c-col [md]="'auto'" class="ms-auto">
                                            <button cButton color="danger" type="button"
                                                    (click)="confirmDelete(def.id)">
                                                Delete Workflow
                                            </button>
                                        </c-col>

                                    </c-row>

                                    <table cTable small="true">
                                        <thead cTableColor="light">
                                        <tr>
                                            <th scope="col">Version</th>
                                            <th scope="col">Creation Time</th>
                                            <th scope="col">Comment</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                            @for (version of def.def.versions | keyvalue; track version.key) {
                                                <tr>
                                                    <th scope="row">v{{ version.key }}</th>
                                                    <td>{{ version.value.creationTime | date:'short' }}</td>
                                                    <td>{{ version.value.description }}</td>
                                                    <td>
                                                        <button cButton (click)="exportVersion(def.id, version.key)"
                                                                size="sm" color="dark" variant="ghost" cTooltip="Download">
                                                            <span class="fa fa-download"></span>
                                                        </button>
                                                        <button cButton (click)="openCopyModal(def.id, version.key)"
                                                                size="sm" color="dark" variant="ghost" cTooltip="Create Copy">
                                                            <span class="fa fa-copy"></span>
                                                        </button>
                                                        @if (Object.keys( def.def.versions ).length > 1) {
                                                            <app-delete-confirm cTooltip="Delete"
                                                                                (delete)="deleteVersion(def.id, version.key)"></app-delete-confirm>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </ng-template>
                        </c-accordion-item>
                    }
                </c-accordion>
            </div>
        }
    }
    @case ('sessions') {
        <h1 class="mb-4">Active Sessions</h1>
        @if (workflowDefs) {
            <ul cListGroup class="mb-3">
                @for (session of userSessions; track session.sessionId) {
                    <ng-container *ngTemplateOutlet="sessionTemplate; context: { $implicit: session }"></ng-container>
                } @empty {
                    <p>There are currently no active user sessions.</p>
                }
            </ul>
        }
    }
    @case ('jobs') {
        <app-job-list></app-job-list>
    }
    @case ('api') {
        <h1>Workflow API</h1>
        <p><kbd>{{ _settings.getConnection( 'workflows.rest' ) }}/api</kbd></p>
        <c-accordion class="mb-5">
            <c-accordion-item #item0="cAccordionItem" [visible]="true">
                <ng-template cTemplateId="accordionHeaderTemplate">
                    <button (click)="item0.toggleItem()" [collapsed]="!item0.visible" cAccordionButton>
                        <h5 class="mb-0">Basic Endpoints</h5>
                    </button>
                </ng-template>

                <ng-template cTemplateId="accordionBodyTemplate">
                    <div class="mx-2 my-2">
                        <ng-container *ngTemplateOutlet="apiEndpoint; context: { method: 'POST', endpoint: '/sessions',
                                description: 'Submit a <code>workflow.json</code> as body to create a new session. <br/> Specify <code>?execute=true</code> to run it immediately.'
                        }"></ng-container>
                        <ng-container *ngTemplateOutlet="apiEndpoint; context: { method: 'POST', endpoint: '/sessions/{sessionId}/execute',
                                description: 'Execute the workflow.  <br/> Specify <code>?target=&#123;activityId&#125;</code> to only execute an activity and its dependencies.'
                        }"></ng-container>
                        <ng-container *ngTemplateOutlet="apiEndpoint; context: { method: 'POST', endpoint: '/sessions/{sessionId}/reset',
                                description: 'Reset workflow execution'
                        }"></ng-container>
                        <ng-container *ngTemplateOutlet="apiEndpoint; context: { method: 'POST', endpoint: '/workflows/{workflowId}/{version}/open',
                                description: 'Create a new session from a stored workflow version. <br/> Specify <code>?execute=true</code> to run it immediately.'
                        }"></ng-container>

                        <ng-container *ngTemplateOutlet="apiEndpoint; context: { method: 'GET', endpoint: '/sessions',
                                description: 'Get a list of active API sessions'
                        }"></ng-container>
                        <ng-container *ngTemplateOutlet="apiEndpoint; context: { method: 'GET', endpoint: '/sessions/{sessionId}/state',
                                description: 'Get the execution state'
                        }"></ng-container>
                        <ng-container *ngTemplateOutlet="apiEndpoint; context: { method: 'GET', endpoint: '/sessions/{sessionId}/workflow/statistics',
                                description: 'Get workflow execution statistics'
                        }"></ng-container>
                        <ng-container *ngTemplateOutlet="apiEndpoint; context: { method: 'GET', endpoint: '/sessions/{sessionId}/workflow/{activityId}/statistics',
                                description: 'Get execution statistics for the specified activity'
                        }"></ng-container>
                        <ng-container *ngTemplateOutlet="apiEndpoint; context: { method: 'GET', endpoint: '/sessions/{sessionId}/workflow/{activityId}/{outIdx}',
                                description: 'Get a result preview for the specified output and activity'
                        }"></ng-container>
                        <ng-container *ngTemplateOutlet="apiEndpoint; context: { method: 'GET', endpoint: '/workflows',
                                description: 'Get a list of stored workflows'
                        }"></ng-container>
                        <ng-container *ngTemplateOutlet="apiEndpoint; context: { method: 'GET', endpoint: '/workflows/{workflowId}/{version}',
                                description: 'Get a stored workflow version'
                        }"></ng-container>


                        <ng-container *ngTemplateOutlet="apiEndpoint; context: { method: 'DELETE', endpoint: '/sessions/{sessionId}',
                                description: 'Terminate the session'
                        }"></ng-container>
                    </div>
                </ng-template>
            </c-accordion-item>
        </c-accordion>

        <h2>API Sessions</h2>
        <ul cListGroup class="mb-3">
            @for (session of apiSessions; track session.sessionId) {
                <ng-container *ngTemplateOutlet="sessionTemplate; context: { $implicit: session }"></ng-container>
            } @empty {
                <p>There are currently no active API sessions.</p>
            }
        </ul>
    }
}

<ng-template #sessionTemplate let-session>
    <li cListGroupItem>
        <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1 limit-name-width">
                @if (session.type === 'USER_SESSION') {
                    <h4 class="session-name">
                        {{ workflowDefs[session.workflowId].name }}
                        v{{ session.version }}
                    </h4>
                    <c-row>
                        <c-col [xs]="4"><small><strong>Session ID:</strong></small></c-col>
                        <c-col [xs]="8"><small>{{ session.sessionId }}</small></c-col>
                    </c-row>
                } @else {
                    <h4>
                        {{ session.sessionId }}
                    </h4>
                }
                <c-row>
                    <c-col [xs]="4"><small><strong>State:</strong></small></c-col>
                    <c-col [xs]="8"><small>{{ session.state }}</small></c-col>
                </c-row>
                <c-row>
                    <c-col [xs]="4"><small><strong>Last Interaction:</strong></small></c-col>
                    <c-col [xs]="8">
                        <small>{{ session.lastInteraction | date: 'yyyy-MM-dd HH:mm:ss' }}</small>
                    </c-col>
                </c-row>
                <c-row>
                    <c-col [xs]="4"><small><strong>Connected Users:</strong></small></c-col>
                    <c-col [xs]="8"><small>{{ session.connectionCount }}</small></c-col>
                </c-row>
                <c-row>
                    <c-col [xs]="4"><small><strong>Activities:</strong></small></c-col>
                    <c-col [xs]="8"><small>{{ session.activityCount }}</small></c-col>
                </c-row>
                <button cButton color="danger" variant="outline" size="sm" class="mt-1"
                        (click)="terminateSession(session.sessionId)">
                    Terminate
                </button>
            </div>
            <button cButton (click)="openSession(session.sessionId)">
                Open
            </button>
        </div>
    </li>
</ng-template>

<ng-template #apiEndpoint let-method="method" let-endpoint="endpoint" let-description="description">
    <c-alert [color]="{'POST': 'success', 'GET': 'primary', 'DELETE': 'danger'}[method]" class="mb-2 p-2">
        <div class="d-flex align-items-center justify-content-between">
            <div class="me-3 d-flex align-items-center">
                <h4 class="me-3 mb-0">
                    <span class="badge" [ngClass]="{'POST': 'bg-success', 'GET': 'bg-primary', 'DELETE': 'bg-danger'}[method]">{{ method }}</span>
                </h4>
                <strong>{{ endpoint }}</strong>
            </div>
            <span [innerHTML]="description" class="text-end"></span>
        </div>
    </c-alert>
</ng-template>

@if (workflowToDelete) {
    <c-modal [visible]="showDeleteModal()" (visibleChange)="showDeleteModal.set($event)">
        <c-modal-header>
            <h5 cModalTitle>Delete Workflow</h5>
            <button (click)="toggleDeleteModal()" cButtonClose></button>
        </c-modal-header>
        <c-modal-body>
            Do you really want to delete all versions of workflow "{{ workflowToDelete.def.name }}"?
            This operation cannot be undone.
        </c-modal-body>
        <c-modal-footer>
            <button (click)="toggleDeleteModal()" cButton color="secondary">Close</button>
            <div>
                <button cButton color="danger" (click)="deleteWorkflow(workflowToDelete.id)">Delete</button>
            </div>
        </c-modal-footer>
    </c-modal>
}

@if (workflowToCopy) {
    <c-modal [visible]="showCopyModal()" (visibleChange)="showCopyModal.set($event)">
        <c-modal-header>
            <h5 cModalTitle>Copy Workflow</h5>
            <button (click)="toggleCopyModal()" cButtonClose></button>
        </c-modal-header>
        <c-modal-body>
            Create a new Workflow from the selected version.
            <c-input-group class="mb-3" cCol>
                <span cInputGroupText>Name</span>
                <input cFormControl placeholder="Workflow Name" [(ngModel)]="copyWorkflowName"
                       autocomplete="off"/>
            </c-input-group>
            <c-input-group class="mb-3">
                <span cInputGroupText>Folder</span>
                <input cFormControl placeholder="Default Folder" [(ngModel)]="copyWorkflowGroup"
                       autocomplete="off"/>
            </c-input-group>
        </c-modal-body>
        <c-modal-footer>
            <button (click)="toggleCopyModal()" cButton color="secondary">Close</button>
            <div>
                <button cButton color="primary" (click)="copyWorkflow()"
                        [disabled]="!copyWorkflowName">
                    Copy
                </button>
            </div>
        </c-modal-footer>
    </c-modal>
}


@if (workflowToModify) {
    <c-modal [visible]="showDescriptionModal()" (visibleChange)="showDescriptionModal.set($event)">
        <c-modal-header>
            <h5 cModalTitle>Set Workflow Description</h5>
            <button (click)="showDescriptionModal.set(false)" cButtonClose></button>
        </c-modal-header>
        <c-modal-body>
            Give a brief description of the workflow (maximal {{ MAX_DESCRIPTION_LENGTH }} characters).
            <div cFormFloating class="mt-3">
                        <textarea class="description-textarea" cFormControl id="floatingTextarea" [(ngModel)]="updatedWorkflowDescription"
                                  placeholder="Workflow Description" autocomplete="off"></textarea>
                <label cLabel for="floatingTextarea">Description</label>
            </div>
        </c-modal-body>
        <c-modal-footer>
            <button (click)="showDescriptionModal.set(false)" cButton color="secondary">Close</button>
            <div>
                <button cButton color="primary" (click)="changeDescription()" [disabled]="updatedWorkflowDescription?.length > MAX_DESCRIPTION_LENGTH">
                    Save
                </button>
            </div>
        </c-modal-footer>
    </c-modal>
}
<form cForm (ngSubmit)="saveConfig()" class="d-flex flex-column h-100">

    <div class="d-flex flex-row align-items-baseline">
        @if (hasConfigChanged()) {
            <span class="text-muted">Discard</span>
            <app-delete-confirm (delete)="resetConfig()"></app-delete-confirm>
        }

        <!-- Save Button -->
        <button class="ms-auto" cButton type="submit" color="primary" *ngIf="isEditable()"
                [disabled]="!hasConfigChanged()">
            Save
        </button>

    </div>

    <div class="config-inputs mt-2 flex-grow-1">

        @if (!isMetaActivity()) {
            <!-- Enforce Checkpoint -->
            <h5><span class="badge text-body bg-light">Disable Optimization</span></h5>
            <c-form-check [switch]="true" class="ms-1 mb-5" *ngIf="def().outPorts.length > 0">
                <label cFormCheckLabel for="form-check-input">Always create checkpoint</label>
                <input cFormCheckInput id="form-check-input" type="checkbox" [(ngModel)]="editableConfig().enforceCheckpoint"
                       name="form-check-input" (change)="checkForChanges()" [disabled]="!isEditable()">
            </c-form-check>


            <!-- Timeout-->
            <h5><span class="badge text-body bg-light">Timeout</span></h5>
            <div class="mb-5">
                <input cFormControl type="number" id="timeout" [(ngModel)]="editableConfig().timeoutSeconds" name="timeout"
                       (change)="checkForChanges()" [disabled]="!isEditable()" min="0">
                <div cFormText>
                    Execution timeout in seconds, or 0 to use workflow default.
                </div>
            </div>

            <!-- Expected Outcome -->
            <h5><span class="badge text-body bg-light">Expected Outcome</span></h5>
            <div class="mb-5">
                <select cSelect id="expectedOutcome" [(ngModel)]="editableConfig().expectedOutcome" name="expectedOutcome"
                        (change)="checkForChanges()" [disabled]="!isEditable()">
                    <option *ngFor="let type of expectedOutcomes" [value]="type">{{ type }}</option>
                </select>
                <div cFormText>
                    Used to determine the overall success of a workflow execution.
                </div>
            </div>

            <!-- Preferred Stores -->
            <h5><span class="badge text-body bg-light">Preferred Stores</span></h5>
            <div class="mb-5" *ngIf="editableConfig().preferredStores?.length > 0">
                @for (outputStore of editableConfig().preferredStores; track i; let i = $index) {
                    <c-input-group class="mb-3">
                        <label cInputGroupText for="preferred-{{i}}">{{ editableConfig().preferredStores.length === 1 ? 'Output' : 'Output ' + i }}</label>
                        <select cSelect id="preferred-{{i}}" [(ngModel)]="editableConfig().preferredStores[i]" name="preferred-{{i}}"
                                (change)="checkForChanges()" [disabled]="!isEditable()">
                            <option [value]="''">Use workflow default</option>
                            <option *ngFor="let adapter of adapters()" [value]="adapter.name">{{ adapter.name + ' (' + adapter.adapterName + ')' }}</option>
                        </select>
                    </c-input-group>
                }
            </div>
        }

        <!-- Common Type -->
        <h5><span class="badge text-body bg-light">Common Transaction</span></h5>
        <div class="mb-5">
            <select cSelect id="commonType" [(ngModel)]="editableConfig().commonType" name="commonType"
                    (change)="checkForChanges()" [disabled]="!isEditable() || lockCommonTransaction()">
                <option *ngFor="let type of commonTypes" [value]="type">{{ type }}</option>
            </select>
            <div cFormText>
                Common transactions provide atomicity, consistency and isolation guarantees over multiple activities. Guarantees do not hold for activities with
                side-effects in external systems.
            </div>
        </div>

        <!-- Control State Merger -->
        <h5><span class="badge text-body bg-light">Control State Merger</span></h5>
        <div class="mb-5">
            <select cSelect id="controlStateMerger" [(ngModel)]="editableConfig().controlStateMerger"
                    name="controlStateMerger" (change)="checkForChanges()" [disabled]="!isEditable()">
                <option *ngFor="let merger of controlStateMergers" [value]="merger">{{ merger }}</option>
            </select>
            <div cFormText>
                Determines whether the activity gets executed in case of multiple control edges. AND_AND means all control edges must be active.
                AND_OR means all success control edges must be active and at least one fail control edge.
            </div>
        </div>

        <!-- Log Errors -->
        <h5><span class="badge text-body bg-light">Log Exception Stacktrace</span></h5>
        <c-form-check [switch]="true" class="ms-1 mb-5" *ngIf="def().outPorts.length > 0">
            <label cFormCheckLabel for="form-check-stacktrace">Log Exception if Activity Fails</label>
            <input cFormCheckInput id="form-check-stacktrace" type="checkbox" [(ngModel)]="editableConfig().logErrors"
                   name="form-check-stacktrace" (change)="checkForChanges()" [disabled]="!isEditable()">
        </c-form-check>
    </div>
</form>


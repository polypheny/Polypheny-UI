@if (activeSettingGroup()) {

    <div class="d-flex flex-column h-100">

        <div class="d-flex flex-row align-items-baseline">

            <ul class="nav nav-underline flex-grow-1" role="tablist" *ngIf="activity().def.nonEmptyGroupCount > 1">
                @for (group of activity().def.groups; track group.key) {
                    <li class="nav-item pt-0" role="presentation" *ngIf="!group.isEmpty">
                        <a class="nav-link"
                           [ngClass]="{'active': activeSettingGroup() === group}"
                           (click)="activeSettingGroup.set(group)"
                           role="tab">{{ group.displayName }}</a>
                    </li>
                }
            </ul>

            @if (isEditable()) {

                <div class="ms-auto" [ngClass]="{'ms-auto': activity().def.nonEmptyGroupCount > 1}">
                    @if (hasSettingsChanged()) {
                        <span class="text-muted">Discard</span>
                        <app-delete-confirm (delete)="resetSettings()"></app-delete-confirm>
                    }
                </div>

                <div class="ms-3" [ngClass]="{'ms-auto': activity().def.nonEmptyGroupCount <= 1}">
                    <c-form-check [switch]="false" [inline]="true">
                        <input cFormCheckInput id="settings-description" type="checkbox" [(ngModel)]="showDescription"
                               name="settings-description">
                        <label cFormCheckLabel for="settings-description">Description</label>
                    </c-form-check>
                </div>

                <div class="ms-3">
                    <button cButton type="submit" color="primary" [disabled]="!hasSettingsChanged()" (click)="saveSettings()">
                        Save
                    </button>
                </div>

            }

        </div>

        <div class="setting-group mt-2 flex-grow-1">
            @if (activity().error()) {
                <c-callout color="danger">
                    <strong>Execution Error: </strong> <span class="text-danger text-break">{{ activity().error().message }}</span>
                </c-callout>
            }
            <p *ngIf="showDescription && activity().def.shortDescription">{{ activity().def.shortDescription }}</p>
            @for (subgroup of activeSettingGroup().subgroups; track activity().id + subgroup.key) {
                <ng-container *ngIf="!subgroup.isEmpty">
                    <h5 *ngIf="!subgroup.isDefault() || true">{{ subgroup.displayName }}</h5>
                    <c-card class="mb-3">
                        <ul cListGroup flush="true">
                            @for (setting of subgroup.settings; track setting.key) {
                                <li cListGroupItem *ngIf="visibilityMap.get( setting.key ) && editableSettings().get(setting.key)">
                                    <div class="d-flex flex-row justify-content-between align-items-center mb-2">
                                        <h6 class="">{{ setting.displayName }}</h6>

                                        <button cButton color="light" class="px-1 d-inline-flex align-items-center" tabindex="-1" size="sm"
                                                (click)="toggleVariablesVisibility(setting.key)">
                                            <span class="cil-bolt me-1"></span>
                                            <span class="badge" [ngClass]="editableReferences().get(setting.key)?.length === 0 ? 'bg-secondary' : 'bg-primary'">
                                            {{ editableReferences().get( setting.key )?.length }}
                                        </span>
                                        </button>
                                    </div>
                                    <p class="text-danger mb-2" *ngIf="activity().invalidSettings()[setting.key]">
                                        {{ activity().invalidSettings()[setting.key] }}
                                    </p>
                                    <p *ngIf="showDescription && setting.shortDescription">{{ setting.shortDescription }}</p>

                                    <!--Variables-->
                                    <div [visible]="variablesVisibilityMap.get(setting.key)?.()" cCollapse>
                                        <app-add-variable [references]="editableReferences().get( setting.key )"
                                                          [workflowVars]="workflowVars()"
                                                          [activityVars]="activity().variables()"
                                                          [settingValue]="editableSettings().get(setting.key).value"
                                                          [isEditable]="isEditable()"
                                                          (add)="addVariableRef(setting.key, $event)"
                                                          (delete)="deleteReference(setting.key, $event)"></app-add-variable>
                                    </div>

                                    <c-alert *ngIf="editableReferences().get( setting.key )?.length > 0" color="warning">
                                        <h5>Note</h5>
                                        The static setting values are only used as a fallback when variables are present.
                                    </c-alert>

                                    @switch (setting.type) {
                                        @case (SettingType.INT) {
                                            <app-int-setting [settingDef]="setting.model" [inTypePreview]="activity().inTypePreview()"
                                                             [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                             [(value)]="editableSettings().get(setting.key).value">
                                            </app-int-setting>
                                        }
                                        @case (SettingType.STRING) {
                                            <app-string-setting [settingDef]="setting.model" [inTypePreview]="activity().inTypePreview()"
                                                                [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                                [(value)]="editableSettings().get(setting.key).value">
                                            </app-string-setting>
                                        }
                                        @case (SettingType.BOOLEAN) {
                                            <app-boolean-setting [settingDef]="setting.model" [inTypePreview]="activity().inTypePreview()"
                                                                 [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                                 [(value)]="editableSettings().get(setting.key).value">
                                            </app-boolean-setting>
                                        }
                                        @case (SettingType.DOUBLE) {
                                            <app-double-setting [settingDef]="setting.model" [inTypePreview]="activity().inTypePreview()"
                                                                [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                                [(value)]="editableSettings().get(setting.key).value">
                                            </app-double-setting>
                                        }
                                        @case (SettingType.ENTITY) {
                                            <app-entity-setting [settingDef]="setting.model" [inTypePreview]="activity().inTypePreview()"
                                                                [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                                [(value)]="editableSettings().get(setting.key).value">
                                            </app-entity-setting>
                                        }
                                        @case (SettingType.QUERY) {
                                            <app-query-setting [settingDef]="setting.model" [inTypePreview]="activity().inTypePreview()"
                                                               [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                               [(value)]="editableSettings().get(setting.key).value">
                                            </app-query-setting>
                                        }
                                        @case (SettingType.FIELD_SELECT) {
                                            <app-field-select-setting [settingDef]="setting.model" [inTypePreview]="activity().inTypePreview()"
                                                                      [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                                      [(value)]="editableSettings().get(setting.key).value">
                                            </app-field-select-setting>
                                        }
                                        @case (SettingType.ENUM) {
                                            <app-enum-setting [settingDef]="setting.model"
                                                              [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                              [(value)]="editableSettings().get(setting.key).value">
                                            </app-enum-setting>
                                        }
                                        @case (SettingType.COLLATION) {
                                            <app-collation-setting [settingDef]="setting.model" [inTypePreview]="activity().inTypePreview()"
                                                                   [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                                   [(value)]="editableSettings().get(setting.key).value">
                                            </app-collation-setting>
                                        }
                                        @case (SettingType.FIELD_RENAME) {
                                            <app-field-rename-setting [settingDef]="setting.model" [inTypePreview]="activity().inTypePreview()"
                                                                      [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                                      [(value)]="editableSettings().get(setting.key).value">
                                            </app-field-rename-setting>
                                        }
                                        @default {
                                            <p class="text-danger">unknown setting type</p>
                                        }
                                    }
                                </li>
                            }
                        </ul>
                    </c-card>
                </ng-container>
            }
        </div>
    </div>

} @else {
    <c-callout color="primary">
        This activity has no settings.
    </c-callout>
}

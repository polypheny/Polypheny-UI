@if (activeSettingGroup()) {

    <div class="d-flex flex-column h-100">

        <div class="d-flex flex-row align-items-baseline">

            <ul class="nav nav-underline flex-grow-1" role="tablist" *ngIf="activity().def.nonEmptyGroupCount > 1">
                @for (group of activity().def.groups; track group.key) {
                    <li class="nav-item pt-0" role="presentation" *ngIf="!group.isEmpty">
                        <a class="nav-link"
                           [ngClass]="{'active': activeSettingGroup() === group}"
                           (click)="activeSettingGroup.set(group)"
                           role="tab">{{ group.displayName }}</a>
                    </li>
                }
            </ul>

            <div class="ms-auto" [ngClass]="{'ms-auto': activity().def.nonEmptyGroupCount > 1}">
                @if (hasSettingsChanged()) {
                    <span class="text-muted">Discard</span>
                    <app-delete-confirm (delete)="resetSettings()"></app-delete-confirm>
                }
            </div>

            <div class="ms-3" [ngClass]="{'ms-auto': activity().def.nonEmptyGroupCount <= 1}">
                <button cButton type="submit" color="primary" *ngIf="isEditable()" class=""
                        [disabled]="!hasSettingsChanged()" (click)="saveSettings()">
                    Save
                </button>
            </div>

        </div>

        <!-- TODO: make itself scrollable if tablist visible-->
        <div class="setting-group mt-2 flex-grow-1">
            @for (subgroup of activeSettingGroup().subgroups; track activity().id + subgroup.key) {
                <ng-container *ngIf="!subgroup.isEmpty">
                    <h5 *ngIf="!subgroup.isDefault() || true">{{ subgroup.displayName }}</h5>
                    <c-card class="mb-3">
                        <ul cListGroup flush="true">
                            @for (setting of subgroup.settings; track setting.key) {
                                <li cListGroupItem *ngIf="visibilityMap.get( setting.key ) && editableSettings().get(setting.key)">
                                    <div class="d-flex flex-row justify-content-between align-items-center mb-2">
                                        <h6 class="">{{ setting.displayName }}
                                            <span class="text-medium-emphasis">({{ setting.key }}: {{ setting.type }})</span>
                                        </h6>

                                        <button cButton color="light" class="px-1 d-inline-flex align-items-center" tabindex="-1" size="sm"
                                                (click)="toggleVariablesVisibility(setting.key)">
                                            <span class="cil-bolt me-1"></span>
                                            <span class="badge" [ngClass]="editableReferences().get(setting.key)?.length === 0 ? 'bg-secondary' : 'bg-primary'">
                                            {{ editableReferences().get( setting.key )?.length }}
                                        </span>
                                        </button>
                                    </div>
                                    <p class="text-danger" *ngIf="activity().invalidSettings()[setting.key]">
                                        {{ activity().invalidSettings()[setting.key] }}
                                    </p>
                                    <p *ngIf="setting.shortDescription">{{ setting.shortDescription }}</p>
                                    <div [visible]="variablesVisibilityMap.get(setting.key)?.()" cCollapse>
                                        <c-card class="mb-2" color="light">
                                            <c-card-body class="py-0">

                                                <ul cListGroup flush="true" size="sm" class="mt-1">
                                                    @for (ref of editableReferences().get( setting.key ); track ref.target) {
                                                        <li cListGroupItem class="d-flex justify-content-between" color="secondary">
                                                            <div class="d-flex align-items-center">
                                                                {{ ref.varRef }}
                                                                <span class="cil-arrow-right mx-3"></span>
                                                                {{ ref.target }}
                                                            </div>
                                                            <button cButton color="light" class="px-1 d-inline-flex align-items-center" tabindex="-1" size="sm"
                                                                    (click)="deleteReference(setting.key, ref)">
                                                                <span class="cil-x"></span>
                                                            </button>
                                                        </li>
                                                    }
                                                </ul>
                                                <div class="mt-1 mb-2">
                                                    <c-input-group>
                                                        <input cFormControl placeholder="Variable" #variableInput/>
                                                        <span cInputGroupText>/</span>
                                                        <input cFormControl placeholder="Pointer" #pointerInput/>
                                                        <span cInputGroupText><span class="cil-arrow-right"></span></span>
                                                        <input cFormControl placeholder="Target" #targetInput/>
                                                        <button cButton type="button" variant="outline" color="secondary" *ngIf="isEditable()"
                                                                (click)="addVariableRef(setting.key, variableInput.value, pointerInput.value, targetInput.value)">
                                                            <span class="cil-plus"></span>
                                                        </button>
                                                    </c-input-group>
                                                </div>
                                            </c-card-body>
                                        </c-card>
                                    </div>
                                    @switch (setting.type) {
                                        @case (SettingType.INT) {
                                            <app-int-setting [settingDef]="setting.model" [inTypePreview]="activity().inTypePreview()"
                                                             [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                             [(value)]="editableSettings().get(setting.key).value">
                                            </app-int-setting>
                                        }
                                        @case (SettingType.STRING) {
                                            <app-string-setting [settingDef]="setting.model" [inTypePreview]="activity().inTypePreview()"
                                                                [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                                [(value)]="editableSettings().get(setting.key).value">
                                            </app-string-setting>
                                        }
                                        @case (SettingType.BOOLEAN) {
                                            <app-boolean-setting [settingDef]="setting.model" [inTypePreview]="activity().inTypePreview()"
                                                                 [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                                 [(value)]="editableSettings().get(setting.key).value">
                                            </app-boolean-setting>
                                        }
                                        @case (SettingType.DOUBLE) {
                                            <app-double-setting [settingDef]="setting.model" [inTypePreview]="activity().inTypePreview()"
                                                                [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                                [(value)]="editableSettings().get(setting.key).value">
                                            </app-double-setting>
                                        }
                                        @case (SettingType.ENTITY) {
                                            <app-entity-setting [settingDef]="setting.model" [inTypePreview]="activity().inTypePreview()"
                                                                [isEditable]="isEditable()" (hasChanged)="checkForChanges()"
                                                                [(value)]="editableSettings().get(setting.key).value">
                                            </app-entity-setting>
                                        }
                                        @default {
                                            <p class="text-danger">unknown setting type</p>
                                        }
                                    }
                                </li>
                            }
                        </ul>
                    </c-card>
                </ng-container>
            }
        </div>
    </div>

} @else {
    <p>This activity has no settings.</p>
}

<div [hidden]="!visible()" class="no-select border-start h-100 d-flex flex-column menu" *ngIf="activity()">
    <div class="px-3 py-2 bg-light border-bottom">
        <div class="d-flex flex-column flex-grow-1">
            <div class="d-flex flex-row align-items-center justify-content-between">
                <h3 class="mb-0">{{ activity().displayName() }}</h3>
                <!-- TODO: also show def name if displayname differs-->
            </div>
            <ul class="nav nav-underline" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link"
                       [ngClass]="{'active': activeTab() === 'settings'}"
                       (click)="changeActiveTab('settings')"
                       role="tab">Settings</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link d-flex align-items-center"
                       [ngClass]="{'active': activeTab() === 'variables'}"
                       (click)="changeActiveTab('variables')"
                       role="tab">
                        Variables
                        <span class="cil-bolt ms-1"></span>
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link"
                       [ngClass]="{'active': activeTab() === 'outputs'}"
                       (click)="changeActiveTab('outputs')"
                       role="tab">Outputs</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link"
                       [ngClass]="{'active': activeTab() === 'execution'}"
                       (click)="changeActiveTab('execution')"
                       role="tab">Execution</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link"
                       [ngClass]="{'active': activeTab() === 'help'}"
                       (click)="changeActiveTab('help')"
                       role="tab">
                        <span class="px-1 fa fa-question-circle"></span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    <div class="px-3 pt-3 menu-body flex-grow-1">
        <div>
            @switch (activeTab()) {
                @case ("settings") {
                    <app-activity-settings #settings [activity]="activity()" [isEditable]="isEditable()"></app-activity-settings>
                }
                @case ("variables") {
                    <!--TODO: force update app-json-text on change-->
                    <p>Available variables after last execution:</p>
                    @for (entry of activity().variables() | keyvalue; track activity().id + entry.key) {
                        <h6 [ngClass]="{'mt-3': !$first, 'mb-0': true}">{{ entry.key }}</h6>
                        <app-json-text [text]="entry.value | json"></app-json-text>
                    }
                }
                @case ("outputs") {
                    <app-checkpoint-viewer [activity]="activity()" [isQueryable]="isEditable()"></app-checkpoint-viewer>
                }
                @case ("execution") {
                    <h5>Config</h5>
                    <app-activity-config-editor [config]="activity().config()" [def]="activity().def" #config
                                                [isEditable]="isEditable()" (save)="save(null, $event, null)"
                    ></app-activity-config-editor>

                    <h5 class="mt-5">Execution Stats</h5>
                    <p><strong>Activity ID:</strong> {{ activity().id }}</p>
                    <p><strong>Activity State:</strong> {{ activity().state() }}</p>

                    @if (activity().executionInfo()) {
                        <p><strong>Execution State:</strong> {{ activity().executionInfo().state }}</p>
                        <p><strong>Executor:</strong> {{ activity().executionInfo().executorType }}</p>
                        <p><strong>Total Duration:</strong> {{ activity().executionInfo().totalDuration }} ms</p>
                        <p *ngIf="activity().executionInfo().activities.length > 1"><strong>Activities:</strong> {{ activity().executionInfo().activities }}</p>

                        <table cTable small="true">
                            <thead cTableColor="light">
                            <tr>
                                <th scope="col">Phase</th>
                                <th scope="col">Time (ms)</th>
                            </tr>
                            </thead>
                            <tbody>
                                @for (state of activity().executionInfo().durations | keyvalue; track state.key) {
                                    <tr>
                                        <th scope="row">{{ state.key }}</th>
                                        <td>{{ state.value }}</td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                    }

                }
                @case ("help") {
                    <app-activity-help [def]="activity().def"></app-activity-help>
                }
            }
        </div>
    </div>
</div>

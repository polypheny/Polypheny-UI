<div class="activity d-flex flex-column h-100" [class.is-opened]="data.isOpened()">

    <div class="status-bar" [ngClass]="'state-' + data.state().toLowerCase()"
         [style.background]="statusBackground?.()">
        <p class="text-center mb-0 status-text"
           [ngClass]="data.state() === ActivityState.IDLE ? 'text-muted' : 'text-light'">
            {{ statusText?.() }}
        </p>
    </div>

    <div class="activity-body h-100 d-flex flex-column">

        <div class="control-bar d-flex flex-row py-1 px-3 align-items-center border-bottom">
            <button cButton size=sm color="warning" *ngIf="data.hasInvalidSettings() || data.invalidReason()"
                    (click)="showProblems()" (pointerdown)="$event.stopPropagation()" title="Show Problems">
                <span class="fa fa-exclamation-triangle text-light"></span>
            </button>
            <div class="flex-grow-1"></div>
            <h6 class="ms-2 mb-0" *ngIf="data.commonType() !== 'NONE'">{{ data.commonType() }}</h6>
            <c-button-group role="group" class="ms-2" size="sm">
                <button cButton color="primary" class="" (click)="data.execute()" *ngIf="data.canExecute()"
                        [disabled]="data.invalidReason() || data.hasInvalidSettings()"
                        (pointerdown)="$event.stopPropagation()">
                    <i class="fa fa-play"></i>
                </button>
                <button cButton color="primary" variant="outline" (click)="data.reset()" *ngIf="data.canReset()"
                        (pointerdown)="$event.stopPropagation()">
                    <i class="fa fa-rotate-left"></i>
                </button>
                <button cButton color="secondary" class="cil-settings" (click)="data.openSettings()"
                        (pointerdown)="$event.stopPropagation()">
                </button>
            </c-button-group>
        </div>

        <div class="d-flex flex-row pt-3 h-100">
            <div class="activity-inputs">
                <div class="input mb-5">
                    <div class="input-socket control-inport" refComponent [emit]="emit"
                         [data]="{type: 'socket', side: 'input', key: IN_CONTROL_KEY, nodeId: data.id, payload: data.controlInput.socket, seed: seed }"
                    ></div>
                </div>


                <div class="input d-flex align-items-center mb-2"
                     *ngFor="let input of data.dataInputs | keyvalue: sortByIndex, let i = index">
                    <div class="input-socket data-inport" refComponent [emit]="emit"
                         [data]="{type: 'socket', side: 'input', key: input.key, nodeId: data.id, payload: input.value?.socket, seed: seed }">
                    </div>
                    <button cButton color="light" class="px-1 py-0" (click)="data.openCheckpoint(true, input.key)"
                            (pointerdown)="$event.stopPropagation()" [disabled]="true">
                        <!--TODO: enable only if predecessor is finished or saved-->
                        <span class="text-dark" [ngClass]="inIcons[input.key]?.()"></span>
                    </button>
                </div>
            </div>

            <div class="activity-content flex-grow-1 h-100 px-1 d-flex flex-column justify-content-between">
                <h4 class="">{{ data.displayName() }}</h4>
                <textarea cFormControl id="activity-notes" class="mb-2" placeholder="Notes"
                          [(ngModel)]="data.rendering().notes"
                          (pointerdown)="$event.stopPropagation()" (change)="saveNotes()">
                    </textarea>
            </div>

            <div class="activity-outputs d-flex flex-column justify-content-between">
                <div>
                    <div class="mb-5 output-spacer"></div>
                    <div class="output mb-2 d-flex align-items-center"
                         *ngFor="let output of data.dataOutputs | keyvalue: sortByIndex">
                        <button cButton color="light" class="px-1 py-0" (click)="data.openCheckpoint(false, output.key)"
                                (pointerdown)="$event.stopPropagation()" [disabled]="!data.canOpenCheckpoint()">
                            <span class="text-dark" [ngClass]="outIcons[output.key]?.()"></span>
                        </button>
                        <div class="output-socket data-outport" refComponent [emit]="emit"
                             [data]="{type: 'socket', side: 'output', key: output.key, nodeId: data.id, payload: output.value?.socket, seed: seed }">
                        </div>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="output" *ngFor="let output of data.controlOutputs | keyvalue: sortByIndex">
                        <div class="output-socket control-outport" refComponent [emit]="emit"
                             [data]="{type: 'socket', side: 'output', key: output.key, nodeId: data.id, payload: output.value?.socket, seed: seed }">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="activity d-flex flex-column h-100" [class.is-opened]="data.isOpened()" [class.meta-activity]="data.isMetaActivity">

    <div class="status-bar" [ngClass]="'state-' + data.state().toLowerCase()"
         [style.background]="statusBackground?.()" [title]="statusText?.()">
        <p class="text-center mb-0 status-text" *ngIf="data.state() === ActivityState.EXECUTING"
           [ngClass]="data.state() === ActivityState.IDLE ? 'text-muted' : 'text-light'">
            {{ statusText?.() }}
        </p>
    </div>

    <div class="activity-body h-100 d-flex flex-column">

        <div class="control-bar d-flex flex-row py-1 px-3 align-items-center border-bottom">
            <button cButton size=sm color="warning" *ngIf="data.hasInvalidSettings() || data.invalidReason()"
                    (click)="showProblems()" (pointerdown)="$event.stopPropagation()" title="Show Problems"
                    class="me-2">
                <span class="fa fa-exclamation-triangle text-light"></span>
            </button>

            <div class="flex-grow-1"></div>
            <h6 class="ms-2 mb-0" *ngIf="data.commonType() !== 'NONE'" [class.text-danger]="data.isRolledBack()"
                [title]="data.isRolledBack() ? 'While the activity might have executed successfully on its own, the common activity was aborted' : 'Common Transaction'">
                {{ data.commonType() }}
                <span *ngIf="data.isRolledBack()"> (aborted)</span>
            </h6>

            @switch (data.expectedOutcome()) {
                @case ('MUST_SUCCEED') {
                    <div class="ms-2">
                        <i [ngClass]="data.isExpectedOutcome() ? 'text-secondary' : 'text-danger'"
                           [title]="data.isExpectedOutcome() ? 'Activity is expected to succeed (see config)': 'Activity was expected to succeed, but failed (see config)'"
                           class="fa fa-check-circle-o"></i>
                    </div>
                }
                @case ('MUST_FAIL') {
                    <div class="ms-2">
                        <i [ngClass]="data.isExpectedOutcome() ? 'text-secondary' : 'text-danger'"
                           [title]="data.isExpectedOutcome() ? 'Activity is expected to fail (see config)': 'Activity was expected to fail, but succeeded (see config)'"
                           class="fa fa-times-circle-o"></i>
                    </div>
                }
            }
            <c-button-group role="group" class="ms-2" size="sm">
                <button cButton color="primary" class="" (click)="data.execute()" *ngIf="data.canExecute()"
                        [disabled]="data.invalidReason() || data.hasInvalidSettings()"
                        (pointerdown)="$event.stopPropagation()">
                    <i class="fa fa-play"></i>
                </button>
                <button cButton color="primary" variant="outline" (click)="data.reset()" *ngIf="data.canReset()"
                        (pointerdown)="$event.stopPropagation()">
                    <i class="fa fa-rotate-left"></i>
                </button>
                <button cButton color="secondary" class="cil-settings px-3" (click)="data.openSettings()"
                        (pointerdown)="$event.stopPropagation()">
                </button>
            </c-button-group>
            <button cButton color="secondary" size="sm" (click)="data.openNested()" *ngIf="data.hasNested && !data.hasInvalidSettings() && !data.invalidReason()"
                    class="ms-1" (pointerdown)="$event.stopPropagation()" title="Open nested workflow">
                <i class="fa fa-sign-in me-1"></i>
            </button>
        </div>

        <div class="d-flex flex-row pt-3 h-100">
            <div class="activity-inputs">
                <div class="input mb-5">
                    <div class="input-socket control-inport" refComponent [emit]="emit"
                         [data]="{type: 'socket', side: 'input', key: IN_CONTROL_KEY, nodeId: data.id, payload: data.controlInput.socket, seed: seed }"
                    ></div>
                </div>


                <div class="input d-flex align-items-center mb-2"
                     *ngFor="let input of data.dataInputs | keyvalue: sortByIndex, let i = index">
                    <div class="input-socket data-inport" refComponent [emit]="emit"
                         [data]="{type: 'socket', side: 'input', key: input.key, nodeId: data.id, payload: input.value?.socket, seed: seed }">
                    </div>
                    <button cButton color="light" class="px-1 py-0" (click)="data.openCheckpoint(true, input.key)"
                            (pointerdown)="$event.stopPropagation()" [disabled]="true">
                        <!--The button is currently always disabled, since it might give the wrong impression that the checkpoint belongs to this activity.
                            To enable it correctly, the state of the predecessor activity would have to be saved or finished.-->
                        <span class="text-dark" [ngClass]="inIcons[input.key]?.()"></span>
                    </button>
                </div>
            </div>

            <div class="activity-content flex-grow-1 h-100 px-1 d-flex flex-column justify-content-between">
                <h3 [class.fst-italic]="data.rendering().name != null" class="text-break">{{ data.displayName() }}</h3>
                <textarea cFormControl id="activity-notes" class="mb-2" placeholder="Notes"
                          [(ngModel)]="data.rendering().notes" spellcheck="false"
                          (pointerdown)="$event.stopPropagation()" (change)="saveNotes()">
                    </textarea>
            </div>

            <div class="activity-outputs d-flex flex-column justify-content-between">
                <div>
                    <div class="mb-5 output-spacer"></div>
                    <div class="output mb-2 d-flex align-items-center justify-content-end"
                         *ngFor="let output of data.dataOutputs | keyvalue: sortByIndex">
                        <button cButton color="light" class="px-1 py-0" (click)="data.openCheckpoint(false, output.key)"
                                (pointerdown)="$event.stopPropagation()" [disabled]="!data.canOpenCheckpoint()">
                            <span class="text-dark" [ngClass]="outIcons[output.key]?.()"></span>
                        </button>
                        <div class="output-socket data-outport" refComponent [emit]="emit"
                             [data]="{type: 'socket', side: 'output', key: output.key, nodeId: data.id, payload: output.value?.socket, seed: seed }">
                        </div>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="output" *ngFor="let output of data.controlOutputs | keyvalue: sortByIndex">
                        <div class="output-socket control-outport" refComponent [emit]="emit"
                             [data]="{type: 'socket', side: 'output', key: output.key, nodeId: data.id, payload: output.value?.socket, seed: seed }">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

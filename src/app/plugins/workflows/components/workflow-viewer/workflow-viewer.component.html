<div class="d-flex flex-column h-100 flex-fill w-100">
    <c-row [gutter]="0" class="align-items-center mb-1">
        <c-col xs="auto" class="ps-1 me-5">
            <c-button-group role="group" class="m-1">
                <button cButton color="light" type="button" (click)="leftMenu.toggleMenu()"
                        [ngClass]="leftMenu.visible() ? 'cil-arrow-thick-to-left' : 'cil-arrow-thick-from-left'">
                </button>
            </c-button-group>
        </c-col>
        <c-col xs="6" md="3">
            <h3 *ngIf="name" class="workflow-name mb-0" [title]="name">{{ name }}</h3>
        </c-col>
        <c-col xs="12" md="6" class="me-auto">
            <c-button-toolbar role="group">
                <c-button-group role="group" class="me-5">
                    <button cButton color="light" class=""
                            (click)="close.emit()">
                        Back
                    </button>
                    <button cButton color="danger" variant="outline" (mouseleave)="terminateConfirm.set(false)"
                            (click)="onTerminateClick()">
                        @if (terminateConfirm()) {
                            <span>Stop Session </span>
                            <span class="fa fa-warning"></span>
                        } @else {
                            <span>Stop Session</span>
                        }

                    </button>
                </c-button-group>
                <c-button-group role="group" class="me-2">
                    <button cButton color="light" class="" (click)="toggleSaveModal()"
                            [disabled]="showSaveModal()" *ngIf="isEditable">
                        <i class="fa fa-save"></i>
                    </button>
                    <button cButton color="light" class="" (click)="arrangeNodes()"
                            [disabled]="isExecuting?.()" *ngIf="isEditable">
                        Arrange
                    </button>
                    <button cButton color="light" class="" (click)="showConfigModal()">
                        Config
                    </button>
                    <button cButton color="light" class="d-flex align-items-center" (click)="openVariableModal()">
                        Variables
                        <span class="cil-bolt ms-1"></span>
                    </button>
                    <button cButton color="light" class="d-flex align-items-center" (click)="showMonitorModal()">
                        Stats
                    </button>
                </c-button-group>

                <c-button-group role="group" class="" *ngIf="isEditable">
                    <button cButton color="primary" class="" (click)="execute()" [disabled]="!canExecute?.()">
                        <i class="fa fa-forward"></i>
                    </button>
                    <button cButton color="light" class="" (click)="reset()"
                            [disabled]="isExecuting?.()">
                        <i class="fa fa-rotate-left"></i>
                    </button>
                    <button cButton color="danger" class="" (click)="interrupt()"
                            [disabled]="workflow?.state() !== 'EXECUTING'">
                        <i class="fa fa-stop"></i>
                    </button>
                </c-button-group>
            </c-button-toolbar>
        </c-col>

        <c-col xs="auto" md="1">
            <span class="badge rounded-pill" *ngIf="workflow" [ngClass]="{
                'bg-primary': workflow.state() === 'IDLE',
                'bg-warning': workflow.state() === 'EXECUTING',
                'bg-danger': workflow.state() === 'INTERRUPTED'
             }">
                {{ workflow.state() }}
            </span>
        </c-col>
        <c-col xs="auto" class="pe-1">
            <c-button-group role="group" class="m-1">
                <button cButton color="light" type="button" (click)="rightMenu.toggleMenu()" *ngIf="openedActivity?.()"
                        [ngClass]="rightMenu.visible() ? 'cil-arrow-thick-to-right' : 'cil-arrow-thick-from-right'">
                </button>
            </c-button-group>
        </c-col>
    </c-row>

    <div class="flex-grow-1 d-flex flex-row editor-container overflow-hidden">
        <app-left-menu #leftMenu [isEditable]="isEditable && !isExecuting?.()"
                       (create)="createActivity($event)" (createAt)="createActivityAt($event)">
        </app-left-menu>
        <div class="rete flex-fill" #rete></div>
        <app-right-menu #rightMenu [activity]="openedActivity?.()" [isEditable]="isEditable && !isExecuting?.()">
        </app-right-menu>
    </div>
</div>

<app-workflow-config-editor #workflowConfigEditor [config]="workflow?.config()"
                            [isEditable]="isEditable && !isExecuting?.()"/>

<app-execution-monitor #executionMonitor [sessionId]="sessionId"
                       (openActivity)="openActivitySettings($event)"/>

<c-modal [visible]="showSaveModal()" (visibleChange)="showSaveModal.set($event)">
    <c-modal-header>
        <h5 cModalTitle>Save Workflow</h5>
        <button (click)="toggleSaveModal()" cButtonClose></button>
    </c-modal-header>
    <c-modal-body>
        You can save this workflow by creating a new version. Please specify a version description:
        <c-input-group>
            <span cInputGroupText>Description</span>
            <input cFormControl type="text" (keyup.enter)="saveWorkflow()" [(ngModel)]="saveMessage"
                   placeholder="Enter save message here...">
        </c-input-group>
    </c-modal-body>
    <c-modal-footer>
        <button (click)="toggleSaveModal()" cButton color="secondary">Close</button>
        <div>
            <button cButton color="primary" (click)="saveWorkflow()">Save Workflow</button>
        </div>
    </c-modal-footer>
</c-modal>

<c-modal [visible]="showVariableModal()" (visibleChange)="showVariableModal.set($event)">
    <c-modal-header>
        <h5 cModalTitle>Workflow Variables</h5>
        <button (click)="toggleVariableModal()" cButtonClose></button>
    </c-modal-header>
    <c-modal-body>
        @if (isEditable) {
            <app-json-editor [json]="workflow?.variables() | json" #variableEditor *ngIf="workflow?.variables()"
                             (valueChange)="editedVariables.set($event)"></app-json-editor>
        } @else {
            <app-json-text [text]="workflow?.variables() | json" *ngIf="workflow?.variables()"></app-json-text>
        }
    </c-modal-body>
    <c-modal-footer>
        <button (click)="toggleVariableModal()" cButton color="secondary">Close</button>
        <div *ngIf="isEditable">
            <button cButton color="primary" (click)="saveVariables()"
                    [disabled]="isExecuting?.() || !hasVariablesChanged()">Save Variables
            </button>
        </div>
    </c-modal-footer>
</c-modal>

<c-modal *ngIf="_checkpoint.selectedActivity()" [visible]="_checkpoint.showModal()"
         (visibleChange)="_checkpoint.setModal($event)" scrollable="true">
    <c-modal-header>
        <h5 cModalTitle>{{ _checkpoint.selectedActivity().displayName() }}:
            Output {{ _checkpoint.selectedOutput() }}</h5>
        <button (click)="_checkpoint.toggleModal()" cButtonClose></button>
    </c-modal-header>
    <c-modal-body>
        @if (_checkpoint.result() || _checkpoint.isLoading()) {
            <div class="d-flex justify-content-center">
                <c-spinner *ngIf="_checkpoint.isLoading()"></c-spinner>
            </div>
            <div class="data-view-wrapper w-100" *ngIf="_checkpoint.result() && _checkpoint.result().data">
                <c-card *ngIf="_checkpoint.isLimited()" color="light" class="mb-3">
                    <c-card-body>
                        <p>Only the first {{ _checkpoint.limit() }} of {{ _checkpoint.totalCount() }} elements are
                            shown.</p>
                    </c-card-body>
                </c-card>
                <app-data-view [result]="_checkpoint.result()"
                               [config]="{create: false, update: false, delete: false, sort: false, search: false, exploring: true, hideCreateView: true}"
                               [loading]="_checkpoint.isLoading()"></app-data-view>
            </div>
        } @else {
            <p>The requested checkpoint is currently not materialized.
                Do you want to execute the activity to materialize its checkpoints?</p>
            <p class="text-danger">This will also reset all its successor activities!</p>

        }
    </c-modal-body>
    <c-modal-footer>
        <button (click)="_checkpoint.toggleModal()" cButton color="secondary">Close</button>
        @if (!_checkpoint.result() && !_checkpoint.isLoading()) {
            <button cButton (click)="_checkpoint.materialize()"
                    [disabled]="_checkpoint.selectedActivity().state() !== 'FINISHED'">Execute Activity
            </button>
        }
    </c-modal-footer>
</c-modal>

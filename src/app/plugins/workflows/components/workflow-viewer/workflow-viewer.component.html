<div class="d-flex flex-column h-100 flex-fill w-100">
    <c-row [gutter]="0" class="align-items-center mb-1 no-select">
        <c-col xs="auto" class="ps-1 me-5">
            <c-button-group role="group" class="m-1" *ngIf="leftMenu">
                <button cButton color="light" type="button" (click)="leftMenu.toggleMenu()"
                        [ngClass]="leftMenu.visible() ? 'cil-arrow-thick-to-left' : 'cil-arrow-thick-from-left'">
                </button>
            </c-button-group>
        </c-col>
        <c-col xs="6" md="3" xl="2" xxl="3">
            <h3 *ngIf="name" class="workflow-name mb-0" [title]="name">{{ name }}</h3>
        </c-col>
        <c-col xs="12" md="7" xl="8" xxl="7">
            <div class="d-inline-flex align-items-center">
                <c-button-toolbar role="group">
                    <c-button-group role="group" class="me-2">
                        <button cButton color="light" class="px-2"
                                (click)="close.emit()">
                            Back
                        </button>
                        <button cButton color="danger" variant="outline" *ngIf="canTerminate"
                                (mouseleave)="terminateConfirm.set(false)" class="px-2"
                                (click)="onTerminateClick()">
                            @if (terminateConfirm()) {
                                <span>Stop Session </span>
                                <span class="fa fa-warning"></span>
                            } @else {
                                <span>Stop Session</span>
                            }
                        </button>
                    </c-button-group>
                    <c-button-group role="group" class="me-2 d-none d-xl-flex">
                        <button cButton color="light" (click)="toggleSaveModal()" class="px-2"
                                [disabled]="showSaveModal()" *ngIf="isEditable">
                            <i class="fa fa-save"></i>
                        </button>
                        <button cButton color="light" (click)="arrangeNodes()" class="px-2"
                                [disabled]="isExecuting?.()" *ngIf="isEditable">
                            Arrange
                        </button>
                        <button cButton color="light" (click)="showConfigModal()" class="px-2">
                            Configuration
                        </button>
                        <button cButton color="light" class="d-flex align-items-center px-2" (click)="openVariableModal()">
                            Variables
                            <span class="cil-bolt ms-1"></span>
                        </button>
                        <button cButton color="light" class="d-flex align-items-center px-2" (click)="showMonitorModal()">
                            Statistics
                        </button>
                        <button cButton color="light" class="d-flex align-items-center px-2"
                                (click)="showHelpModal()">
                            <span class="fa fa-question-circle-o"></span>
                        </button>
                    </c-button-group>

                    <c-dropdown class="d-flex d-xl-none me-2">
                        <button cButton cDropdownToggle color="light" class="px-2">
                            Workflow
                        </button>
                        <ul cDropdownMenu>
                            <li><a cDropdownItem (click)="toggleSaveModal()"
                                   [disabled]="showSaveModal()" *ngIf="isEditable">
                                <i class="fa fa-save"></i> Save
                            </a></li>
                            <li><a cDropdownItem (click)="arrangeNodes()"
                                   [disabled]="isExecuting?.()" *ngIf="isEditable">
                                Arrange
                            </a></li>
                            <li><a cDropdownItem (click)="showConfigModal()">Configuration</a></li>
                            <li><a cDropdownItem (click)="openVariableModal()">
                                Variables
                                <span class="cil-bolt ms-1"></span>
                            </a></li>
                            <li><a cDropdownItem (click)="showMonitorModal()">Statistics</a></li>
                            <li><a cDropdownItem (click)="showHelpModal()">Help</a></li>
                        </ul>
                    </c-dropdown>

                    <c-button-group role="group" class="" *ngIf="isEditable">
                        <button cButton color="primary" class="" (click)="execute()" [disabled]="!canExecute?.()">
                            <i class="fa fa-forward"></i>
                        </button>
                        <button cButton color="light" class="" (click)="reset()"
                                [disabled]="isExecuting?.()">
                            <i class="fa fa-rotate-left"></i>
                        </button>
                        <button cButton color="danger" class="" (click)="interrupt()"
                                [disabled]="workflow?.state() !== 'EXECUTING'">
                            <i class="fa fa-stop"></i>
                        </button>
                    </c-button-group>
                </c-button-toolbar>
                <div>
                <span class="badge rounded-pill ms-2" *ngIf="workflow" [ngClass]="{
                    'bg-primary': workflow.state() === 'IDLE',
                    'bg-warning': workflow.state() === 'EXECUTING',
                    'bg-danger': workflow.state() === 'INTERRUPTED'
                 }">
                    {{ workflow.state() }}
                </span>

                </div>

            </div>
        </c-col>
        <c-col xs="auto" class="ms-auto pe-1">
            <c-button-group role="group" class="m-1">
                <button cButton color="light" type="button" (click)="rightMenu.toggleMenu()" *ngIf="openedActivity?.()"
                        [ngClass]="rightMenu.visible() ? 'cil-arrow-thick-to-right' : 'cil-arrow-thick-from-right'">
                </button>
            </c-button-group>
        </c-col>
    </c-row>

    <div class="flex-grow-1 d-flex flex-row editor-container overflow-hidden">
        <app-left-menu #leftMenu [isEditable]="isEditable && !isExecuting?.()" *ngIf="isEditable"
                       (create)="createActivity($event)" (createAt)="createActivityAt($event)">
        </app-left-menu>
        <div class="rete flex-fill" #rete></div>
        <app-right-menu #rightMenu [activity]="openedActivity?.()" [isEditable]="isEditable && !isExecuting?.()"
                        [workflowVars]="workflow?.variables()">
        </app-right-menu>
    </div>
</div>

<app-workflow-config-editor #workflowConfigEditor [config]="workflow?.config()"
                            [isEditable]="isEditable && !isExecuting?.()"/>

<app-execution-monitor #executionMonitor [sessionId]="sessionId" [workflow]="workflow"
                       (openActivity)="openActivitySettings($event)"/>

<c-modal [visible]="showSaveModal()" (visibleChange)="showSaveModal.set($event)">
    <c-modal-header>
        <h5 cModalTitle>Save Workflow</h5>
        <button (click)="toggleSaveModal()" cButtonClose></button>
    </c-modal-header>
    <c-modal-body>
        <p>You can save this workflow by creating a new version. Please specify a version description:</p>
        <c-input-group>
            <span cInputGroupText>Description</span>
            <input cFormControl type="text" (keyup.enter)="saveWorkflow()" [(ngModel)]="saveMessage"
                   placeholder="Enter save message here...">
        </c-input-group>
    </c-modal-body>
    <c-modal-footer>
        <button (click)="toggleSaveModal()" cButton color="secondary">Close</button>
        <div>
            <button cButton color="primary" (click)="saveWorkflow()">Save Workflow</button>
        </div>
    </c-modal-footer>
</c-modal>

<c-modal [visible]="showVariableModal()" (visibleChange)="showVariableModal.set($event)">
    <c-modal-header>
        <h5 cModalTitle>Workflow Variables</h5>
        <button (click)="toggleVariableModal()" cButtonClose></button>
    </c-modal-header>
    <c-modal-body>
        @if (isEditable) {
            <app-json-editor [json]="workflow?.variables() | json" #variableEditor *ngIf="workflow?.variables()"
                             (valueChange)="editedVariables.set($event)"></app-json-editor>
        } @else {
            <app-json-text [text]="workflow?.variables() | json" *ngIf="workflow?.variables()"></app-json-text>
        }
    </c-modal-body>
    <c-modal-footer>
        <button (click)="toggleVariableModal()" cButton color="secondary">Close</button>
        <div *ngIf="isEditable">
            <button cButton color="primary" (click)="saveVariables()"
                    [disabled]="isExecuting?.() || !hasVariablesChanged()">Save Variables
            </button>
        </div>
    </c-modal-footer>
</c-modal>

<app-checkpoint-viewer></app-checkpoint-viewer>

<app-workflow-help #workflowHelp></app-workflow-help>
